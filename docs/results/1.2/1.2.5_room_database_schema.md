# 1.2.5 Room Database Schema

**Task**: Set up Room database with Task-Goal schema  
**Owner**: Android Developer  
**Status**: ✅ Completed  
**Date**: February 4, 2026

---

## Database Overview

**Database Name**: `jeeves_database`  
**Version**: 1  
**Schema Export**: Enabled (for migration verification)

---

## Entity Relationship Diagram

```
┌─────────────────┐      ┌─────────────────┐
│   TaskEntity    │      │   GoalEntity    │
├─────────────────┤      ├─────────────────┤
│ id (PK)         │      │ id (PK)         │
│ title           │      │ title           │
│ notes           │      │ description     │
│ due_date        │      │ original_input  │
│ quadrant        │─────>│ category        │
│ goal_id (FK)    │      │ target_date     │
│ parent_task_id  │      │ progress        │
│ is_recurring    │      │ is_completed    │
│ recurrence_pat  │      │ completed_at    │
│ urgency_score   │      │ created_at      │
│ ai_explanation  │      │ updated_at      │
│ ai_confidence   │      └─────────────────┘
│ is_completed    │              │
│ completed_at    │              │
│ created_at      │              │
│ updated_at      │              ▼
│ position        │      ┌─────────────────┐
└─────────────────┘      │ MilestoneEntity │
        │                ├─────────────────┤
        │                │ id (PK)         │
        │ (subtasks)     │ goal_id (FK)    │
        └───────┐        │ title           │
                │        │ target_date     │
                ▼        │ is_completed    │
         (self-ref)      │ completed_at    │
                         │ position        │
                         │ created_at      │
                         │ updated_at      │
                         └─────────────────┘

┌─────────────────┐      ┌─────────────────────┐
│  MeetingEntity  │      │ DailyAnalyticsEntity│
├─────────────────┤      ├─────────────────────┤
│ id (PK)         │      │ id (PK)             │
│ calendar_id     │      │ date (unique)       │
│ title           │      │ tasks_created       │
│ description     │      │ tasks_completed     │
│ location        │      │ q1_completed        │
│ start_time      │      │ q2_completed        │
│ end_time        │      │ q3_completed        │
│ attendees (JSON)│      │ q4_completed        │
│ notes           │      │ goals_progressed    │
│ action_items    │      │ ai_classifications  │
│ agenda          │      │ ai_overrides        │
│ created_at      │      │ briefing_opened     │
│ updated_at      │      │ summary_opened      │
└─────────────────┘      └─────────────────────┘
```

---

## TaskEntity

Based on TM-001 through TM-010 from [0.3.2 Task Management User Stories](../0.3/0.3.2_task_management_user_stories.md).

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | Long | No | Primary key, auto-generated |
| title | String | No | Task title |
| notes | String | Yes | Additional notes |
| due_date | Instant | Yes | Due date/time |
| quadrant | EisenhowerQuadrant | No | Q1/Q2/Q3/Q4 classification |
| goal_id | Long | Yes | FK to GoalEntity |
| parent_task_id | Long | Yes | FK for subtasks |
| is_recurring | Boolean | No | Recurring task flag |
| recurrence_pattern | RecurrencePattern | Yes | Daily/Weekly/Monthly/etc. |
| urgency_score | Float | No | Calculated urgency (0-1) |
| ai_explanation | String | Yes | AI classification explanation |
| ai_confidence | Float | No | AI confidence score (0-1) |
| is_completed | Boolean | No | Completion status |
| completed_at | Instant | Yes | Completion timestamp |
| created_at | Instant | No | Creation timestamp |
| updated_at | Instant | No | Last update timestamp |
| position | Int | No | Manual ordering |

**Indexes**: goal_id, parent_task_id, quadrant, due_date, is_completed

---

## GoalEntity

Based on GL-001 through GL-006 from [0.3.3 Goals User Stories](../0.3/0.3.3_goals_user_stories.md).

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | Long | No | Primary key |
| title | String | No | Goal title |
| description | String | Yes | Detailed description |
| original_input | String | Yes | User's original input before AI refinement |
| category | GoalCategory | No | Career/Health/Personal/etc. |
| target_date | LocalDate | Yes | Goal deadline |
| progress | Int | No | Progress percentage (0-100) |
| is_completed | Boolean | No | Completion status |
| completed_at | Instant | Yes | Completion timestamp |
| created_at | Instant | No | Creation timestamp |
| updated_at | Instant | No | Last update timestamp |

**Indexes**: category, target_date, is_completed

---

## Key DAO Queries

### TaskDao

```kotlin
// Get tasks by quadrant for Eisenhower Matrix view
fun getByQuadrant(quadrant: EisenhowerQuadrant): Flow<List<TaskEntity>>

// Get overdue tasks for priority alerts
fun getOverdue(now: Long): Flow<List<TaskEntity>>

// Get tasks linked to a goal for progress calculation
fun getActiveByGoalId(goalId: Long): List<TaskEntity>

// Full-text search
fun search(query: String): Flow<List<TaskEntity>>
```

### GoalDao

```kotlin
// Get active goals with count limit (max 10 per GL-001)
fun getActiveGoalCount(): Int

// Get goals needing attention (sorted by lowest progress)
fun getGoalsNeedingAttention(limit: Int): Flow<List<GoalEntity>>
```

---

## Type Converters

```kotlin
class JeevesTypeConverters {
    // Instant ↔ Long (epoch milliseconds)
    // LocalDate ↔ String (ISO format)
    // EisenhowerQuadrant ↔ String (enum name)
    // GoalCategory ↔ String (enum name)
    // RecurrencePattern ↔ String (enum name)
}
```

---

## Migration Strategy

- **MVP**: `fallbackToDestructiveMigration()` for rapid iteration
- **v1.1+**: Proper migration scripts with schema versioning
- Schema export enabled for verification

---

*Document Owner: Android Developer*  
*Last Updated: February 4, 2026*
