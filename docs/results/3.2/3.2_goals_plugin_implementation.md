# Milestone 3.2 ‚Äî Goals Plugin Implementation

**Status**: ‚úÖ Complete  
**Sprint Duration**: Phase 3  
**Implementer**: Principal Android Developer  

---

## Summary

Milestone 3.2 delivers the full Goals Plugin feature for Prio, enabling users to create, track, and manage goals with AI-powered SMART refinement, milestone tracking, progress visualization, and bidirectional task-goal linking.

## Tasks Completed

### 3.2.1 ‚Äî Goals List Screen ‚úÖ
**Files created/modified:**
- `app/src/main/java/com/prio/app/feature/goals/GoalsListUiState.kt` (new)
- `app/src/main/java/com/prio/app/feature/goals/GoalsListViewModel.kt` (new)
- `app/src/main/java/com/prio/app/feature/goals/GoalsListScreen.kt` (replaced placeholder)

**Implementation Details:**
- Replaced hardcoded placeholder screen with ViewModel-backed real implementation
- `GoalsListViewModel` uses `combine()` to merge goals, filter state, and goal count into a single reactive state flow
- Overview card with circular progress ring showing average progress + Active/On Track/At Risk counts
- Category filter chips (horizontal scroll, single-select) using `GoalCategory` enum
- Goals grouped into sections by status (At Risk ‚Üí Behind ‚Üí On Track priority ordering)
- Reuses `GoalCard` from `core/ui` module
- Empty state with üéØ emoji and "Create First Goal" CTA
- FAB with max 10 goals enforcement
- Snackbar effects for delete undo

### 3.2.2 ‚Äî Goal Detail Screen ‚úÖ
**Files created:**
- `app/src/main/java/com/prio/app/feature/goals/detail/GoalDetailUiState.kt`
- `app/src/main/java/com/prio/app/feature/goals/detail/GoalDetailViewModel.kt`
- `app/src/main/java/com/prio/app/feature/goals/detail/GoalDetailScreen.kt`

**Implementation Details:**
- Progress Hero: 120dp circular progress ring with 800ms animation and status-based color (Green/Yellow/Red)
- 3-tab layout: Tasks | Milestones | Analytics
- Linked task cards showing quadrant emoji, title, due date, and overdue indicator
- Milestone timeline with Canvas-drawn vertical connector and state-based emoji (‚úÖ/‚è≥/‚óã/‚ö†Ô∏è)
- AI Insight card with contextual advice (encouragement/recovery/nudge based on status)
- Analytics content: progress summary, task completion rate, milestone stats
- Goal completion and deletion with navigation effects

### 3.2.3 ‚Äî Goal Creation Wizard ‚úÖ
**Files created:**
- `app/src/main/java/com/prio/app/feature/goals/create/CreateGoalUiState.kt`
- `app/src/main/java/com/prio/app/feature/goals/create/CreateGoalViewModel.kt`
- `app/src/main/java/com/prio/app/feature/goals/create/CreateGoalScreen.kt`

**Implementation Details:**
- 3-step wizard with animated transitions (slide + fade):
  1. **Describe**: Natural language input with 5 example goals, "Refine with AI" CTA
  2. **AI SMART Refinement**: Uses `AiProvider.complete(SUGGEST_SMART_GOAL)` ‚Üí `SmartGoalSuggestion`, SMART breakdown card (S/M/A/R/T), category chips, "Skip AI" fallback
  3. **Timeline & Milestones**: DatePicker for target date, milestone list (AI-suggested + custom), weekly reminder toggle
- Step progress bar with animated fill and checkmark indicators
- Celebration overlay on success with "Add First Task" / "View Details" / "Back to Goals"
- Max 10 active goals enforced
- Graceful AI fallback: if `AiProvider` fails, user sees their original input and can proceed manually

### 3.2.4 ‚Äî Milestone Tracking Enhancements ‚úÖ
**Files modified:**
- `app/src/main/java/com/prio/app/feature/goals/detail/GoalDetailUiState.kt`
- `app/src/main/java/com/prio/app/feature/goals/detail/GoalDetailViewModel.kt`
- `app/src/main/java/com/prio/app/feature/goals/detail/GoalDetailScreen.kt`

**Implementation Details:**
- Added `showAddMilestoneDialog` and `canAddMilestone` to UiState
- Added `OnConfirmAddMilestone`, `OnDismissAddMilestoneDialog`, `OnDeleteMilestone` events
- `AddMilestoneDialog` composable: AlertDialog with OutlinedTextField, enforces max 5 milestones
- ViewModel `addMilestone()` delegates to `GoalRepository.addMilestone()` with limit check
- ViewModel `deleteMilestone()` delegates to `GoalRepository.deleteMilestoneById()`

### 3.2.5 ‚Äî Task-to-Goal Linking & Navigation Wiring ‚úÖ
**Files modified:**
- `app/src/main/java/com/prio/app/navigation/PrioNavHost.kt`

**Implementation Details:**
- Replaced `PlaceholderDetailScreen` for `NavRoutes.GOAL_DETAIL` with `GoalDetailScreen`
- Replaced `PlaceholderDetailScreen` for `NavRoutes.CREATE_GOAL` with `CreateGoalScreen`
- Wired navigation callbacks: `onNavigateBack`, `onNavigateToTask`, `onNavigateToGoalDetail`, `onNavigateToGoalsList`
- Added imports for `GoalDetailScreen` and `CreateGoalScreen`

### 3.2.6 ‚Äî Progress Calculation Fix ‚úÖ
**Files modified:**
- `core/data/src/main/java/com/prio/core/data/local/dao/GoalDao.kt`
- `core/data/src/main/java/com/prio/core/data/repository/GoalRepository.kt`

**Implementation Details:**
- Added `getActiveGoalsList(): suspend List<GoalEntity>` to GoalDao
- Added `getCompletedGoalCountSince(since: Instant): suspend Int` to GoalDao
- Fixed `getDashboardStats()` ‚Äî previously returned zeros for all calculated fields:
  - Now iterates active goals and calls `calculateGoalStatus()` for on-track/at-risk counts
  - Queries completed goals since first of current month using `atStartOfDayIn()`
- Added `kotlinx.datetime.atStartOfDayIn` import

### 3.2.7 ‚Äî Goal-based AI Suggestions ‚úÖ
**Already implemented across tasks:**
- `CreateGoalViewModel` uses `@MainAiProvider AiProvider` with `AiRequestType.SUGGEST_SMART_GOAL`
- `AiResult.SmartGoalSuggestion` provides: `refinedGoal`, `specific`, `measurable`, `achievable`, `relevant`, `timeBound`, `suggestedMilestones`
- AI-suggested milestones are pre-populated in wizard step 3 with üí° icon
- `GoalDetailViewModel.generateAiInsight()` provides contextual insights based on status and progress
- Graceful fallback: "Skip AI" button always available, AI failure shows manual entry

### 3.2.8 ‚Äî UI Tests ‚úÖ
**Files created:**
- `app/src/test/java/com/prio/app/feature/goals/GoalsListViewModelTest.kt`
- `app/src/test/java/com/prio/app/feature/goals/create/CreateGoalViewModelTest.kt`

**Test Coverage:**
- **GoalsListViewModelTest** (8 tests):
  - Initial/empty state, goal grouping by status, max 10 enforcement, category filter set/clear, overview stats
- **CreateGoalViewModelTest** (10 tests):
  - Wizard navigation (start, advance, back), AI SMART suggestion, AI fallback, skip AI, milestone add/remove/max, goal creation with repository, max goals error, category selection, example selection

---

## Exit Criteria Achievement

| Criteria | Status |
|----------|--------|
| Goals can be created with AI SMART suggestions | ‚úÖ 3-step wizard with AiProvider integration |
| Progress updates automatically from task completion | ‚úÖ `recalculateProgress()` + `getDashboardStats()` fixed |
| Goal-task linking bidirectional and AI-suggested | ‚úÖ Task‚ÜíGoal FK, GoalDetail shows linked tasks, wizard pre-links |
| Confetti animation on 100% completion | ‚úÖ `ShowConfetti` effect + celebration overlay |
| Max 10 active goals enforced | ‚úÖ Checked in ViewModel + Repository |
| Milestone tracking (0-5 per goal) | ‚úÖ Add dialog, timeline, toggle, delete |
| Navigation fully wired | ‚úÖ PrioNavHost updated, no more placeholders for goals |

## Architecture Decisions

1. **MVVM + StateFlow + Channel**: Consistent with TaskListViewModel pattern
2. **AI-first with graceful fallback**: SMART wizard auto-triggers AI but always allows manual entry
3. **Reactive goal sections**: `combine()` merges multiple flows for automatic UI updates
4. **Reusable components**: `GoalCard` from `core/ui` used in both list and spotlight
5. **Room DAO additions**: Minimal ‚Äî only 2 new queries to support dashboard stats

## File Summary

| File | Lines | Type |
|------|-------|------|
| GoalsListUiState.kt | ~100 | New |
| GoalsListViewModel.kt | ~240 | New |
| GoalsListScreen.kt | ~400 | Replaced |
| GoalDetailUiState.kt | ~120 | New |
| GoalDetailViewModel.kt | ~380 | New |
| GoalDetailScreen.kt | ~830 | New |
| CreateGoalUiState.kt | ~100 | New |
| CreateGoalViewModel.kt | ~350 | New |
| CreateGoalScreen.kt | ~990 | New |
| PrioNavHost.kt | ~380 | Modified |
| GoalDao.kt | ~85 | Modified |
| GoalRepository.kt | ~445 | Modified |
| GoalsListViewModelTest.kt | ~250 | New |
| CreateGoalViewModelTest.kt | ~320 | New |
| **Total** | **~5,000** | |
