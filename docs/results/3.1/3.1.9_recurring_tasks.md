# Task 3.1.9: Recurring Tasks Implementation

**Owner**: Android Developer  
**Duration**: 2h  
**Status**: ✅ Completed  
**Date**: February 4, 2026

---

## Overview

This document describes the implementation of recurring tasks for Prio MVP, as specified in TM-008 from the Task Management User Stories.

Recurring tasks allow users to create tasks that automatically regenerate after completion, supporting common patterns like daily standup meetings, weekly reports, or monthly reviews.

---

## Requirements (TM-008)

Per [0.3.2_task_management_user_stories.md](../0.3/0.3.2_task_management_user_stories.md):

| Acceptance Criteria | Status |
|---------------------|--------|
| Option to make task recurring when creating/editing | ✅ Model ready |
| Recurrence options: Daily, Weekly, Monthly, Custom | ✅ Implemented |
| When recurring task completed, next instance created automatically | ✅ Via WorkManager |
| Show recurrence indicator in task list | ✅ `isRecurring` field |
| Edit recurrence pattern from task detail | ✅ Model supports |
| "Skip this occurrence" option | ⏳ P1.1 |
| "End recurrence" stops future instances | ✅ Via scheduler cancel |
| Recurring tasks remember quadrant for new instances | ✅ Implemented |

---

## Architecture

### Design Decisions

1. **Lazy Creation**: Next occurrence is created only when current instance is completed (not pre-generated)
   - Rationale: Reduces database size, handles edge cases better
   
2. **WorkManager-based**: Uses WorkManager for reliable background execution
   - Rationale: Survives app kill, handles system constraints
   
3. **Immutable Instances**: Each occurrence is a separate TaskEntity
   - Rationale: Allows independent completion tracking, preserves history

### Components

```
┌─────────────────────────────────────────────────────────────────┐
│                     RECURRING TASK FLOW                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────┐    ┌──────────────────┐                   │
│  │ TaskListViewModel │───▶│RecurringTaskSched│                   │
│  │   completeTask()  │    │  scheduleNext()  │                   │
│  └──────────────────┘    └────────┬─────────┘                   │
│                                   │                              │
│                                   ▼                              │
│                     ┌──────────────────────┐                     │
│                     │     WorkManager      │                     │
│                     │   (OneTimeRequest)   │                     │
│                     └────────┬─────────────┘                     │
│                              │                                   │
│                              ▼                                   │
│                     ┌──────────────────────┐                     │
│                     │ RecurringTaskWorker  │                     │
│                     │  calculateNextDate() │                     │
│                     │  createNextTask()    │                     │
│                     └────────┬─────────────┘                     │
│                              │                                   │
│                              ▼                                   │
│                     ┌──────────────────────┐                     │
│                     │   TaskRepository     │                     │
│                     │     insertTask()     │                     │
│                     └──────────────────────┘                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Implementation Details

### 1. RecurrencePattern Enum

Location: `core/common/src/main/java/com/prio/core/common/model/RecurrencePattern.kt`

```kotlin
enum class RecurrencePattern(val displayName: String) {
    DAILY("Daily"),
    WEEKLY("Weekly"),
    MONTHLY("Monthly"),
    YEARLY("Yearly"),
    WEEKDAYS("Weekdays"),
    CUSTOM("Custom")
}
```

### 2. TaskEntity Fields

```kotlin
@ColumnInfo(name = "is_recurring")
val isRecurring: Boolean = false,

@ColumnInfo(name = "recurrence_pattern")
val recurrencePattern: RecurrencePattern? = null,
```

### 3. RecurringTaskScheduler

Location: `app/src/main/java/com/prio/app/worker/RecurringTaskScheduler.kt`

Key responsibilities:
- Schedule WorkManager request when task is completed
- Cancel pending work when recurrence is ended
- Use unique work names to prevent duplicates

```kotlin
fun scheduleNextOccurrence(completedTaskId: Long) {
    val workRequest = OneTimeWorkRequestBuilder<RecurringTaskWorker>()
        .setInputData(inputData)
        .build()
    
    WorkManager.getInstance(context).enqueueUniqueWork(
        uniqueName,
        ExistingWorkPolicy.REPLACE,
        workRequest
    )
}
```

### 4. RecurringTaskWorker

Location: `app/src/main/java/com/prio/app/worker/RecurringTaskWorker.kt`

Key responsibilities:
- Retrieve completed task from repository
- Calculate next due date based on pattern
- Create new TaskEntity preserving quadrant and settings
- Handle errors with retry logic

#### Date Calculation Logic

| Pattern | Calculation |
|---------|-------------|
| DAILY | `referenceDate + 1 day` |
| WEEKLY | `referenceDate + 7 days` |
| MONTHLY | `referenceDate + 1 month` |
| YEARLY | `referenceDate + 1 year` |
| WEEKDAYS | Next Mon-Fri (skips weekend) |
| CUSTOM | Default to +1 day (v1.1: interval support) |

---

## Integration Points

### TaskListViewModel

Updated to schedule recurring task on completion:

```kotlin
private fun handleTaskComplete(taskId: Long) {
    viewModelScope.launch {
        val task = taskRepository.getTaskById(taskId)
        lastCompletedTask = task
        
        taskRepository.completeTask(taskId)
        
        // Schedule next occurrence if recurring (TM-008)
        if (task?.isRecurring == true && task.recurrencePattern != null) {
            recurringTaskScheduler.scheduleNextOccurrence(taskId)
        }
    }
}
```

### Snackbar Message

When recurring task is completed:
```
"Task completed. Next occurrence created."
```

---

## Testing

### Unit Tests

Location: `app/src/androidTest/java/com/prio/app/worker/RecurringTaskDateCalculationTest.kt`

| Test Case | Description |
|-----------|-------------|
| `dailyRecurrence_addsOneDay` | Daily pattern adds 1 day |
| `weeklyRecurrence_addsOneWeek` | Weekly pattern adds 7 days |
| `monthlyRecurrence_addsOneMonth` | Monthly pattern adds 1 month |
| `yearlyRecurrence_addsOneYear` | Yearly pattern adds 1 year |
| `weekdaysRecurrence_skipsWeekend` | Friday → Monday |
| `recurrence_preservesTimeOfDay` | Time component preserved |
| `recurrence_withNullDueDate_usesCompletedAt` | Fallback to completion time |
| `monthlyRecurrence_handlesEndOfMonth` | Jan 31 → Feb 28 |

---

## Future Enhancements (P1.1)

1. **Custom Intervals**: "Every N days/weeks/months"
2. **Skip Occurrence**: Skip without completing
3. **End Date**: Recurring stops after specific date
4. **Day Selection**: Weekly on specific days (Mon, Wed, Fri)
5. **History View**: See all completed occurrences

---

## Dependencies Added

```toml
# gradle/libs.versions.toml
workManager = "2.9.0"

[libraries]
workmanager-runtime = { group = "androidx.work", name = "work-runtime-ktx" }
hilt-work = { group = "androidx.hilt", name = "hilt-work" }
```

---

## Files Created/Modified

### Created
- `app/src/main/java/com/prio/app/worker/RecurringTaskWorker.kt`
- `app/src/main/java/com/prio/app/worker/RecurringTaskScheduler.kt`
- `app/src/androidTest/java/com/prio/app/worker/RecurringTaskDateCalculationTest.kt`

### Modified
- `gradle/libs.versions.toml` - Added WorkManager dependencies
- `app/build.gradle.kts` - Added WorkManager bundle
- `app/src/main/java/com/prio/app/PrioApplication.kt` - WorkManager initialization
- `app/src/main/java/com/prio/app/feature/tasks/TaskListViewModel.kt` - Recurring task handling

---

## Verification

- [x] WorkManager initialized with HiltWorkerFactory
- [x] RecurrencePattern enum matches TM-008 requirements
- [x] Next occurrence created with correct date
- [x] Quadrant preserved for new instances
- [x] Unit tests pass for all recurrence patterns
