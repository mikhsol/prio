# 3.1.5.B â€” Bug Fixes & Integration

**Milestone**: 3.1.5.B â€” Bug Fixes & Integration (Phase 3: Feature Plugins)  
**Owner**: Android Developer  
**Status**: âœ… Completed (6/6 tasks)  
**Duration**: ~4h, completed in single session  
**UX Specs**: [1.1.1](../1.1/1.1.1_task_list_screen_spec.md), [1.1.2](../1.1/1.1.2_task_detail_spec.md), [1.1.3](../1.1/1.1.3_quick_capture_flow_spec.md)  
**Date**: February 2026

---

## Summary

Completed all 6 tasks in the 3.1.5.B bug fixes and integration milestone. This work bridges the gap between standalone feature screens and a fully wired navigation experience. Key deliverables: real task detail screen replacing placeholder, overflow menu with edit/duplicate/copy/delete actions, Material3 DatePicker and Goal Picker in Quick Capture, and a reminder indicator on task cards.

---

## Task Breakdown

| # | Task | Status | Description |
|---|------|--------|-------------|
| B.1 | Wire TaskDetailSheet to navigation | âœ… | Created `TaskDetailScreen` wrapper, replaced `PlaceholderDetailScreen` in NavHost |
| B.2 | Overflow menu in TaskDetail | âœ… | `DropdownMenu` with Edit, Duplicate, Copy, Delete + ViewModel handlers |
| B.3 | Voice input with SpeechRecognizer | âœ… | Already completed (see [separate report](3.1.5.B.3_voice_input_implementation.md)) |
| B.4 | Date picker in Quick Capture | âœ… | Material3 `DatePickerDialog` wired to parsed result preview |
| B.5 | Goal picker in Quick Capture | âœ… | `GoalPickerSheet` with active goals list from `GoalRepository` |
| B.6 | Reminder indicator on task cards | âœ… | Bell emoji (ðŸ””) in `MetadataRow`, `hasReminder` field in `TaskCardData` |

---

## Implementation Details

### B.1 â€” Wire TaskDetailSheet to Navigation

**Problem**: The `PrioNavHost` used a `PlaceholderDetailScreen` stub for the task detail route. Users tapping a task card saw a grey placeholder instead of real task details.

**Solution**: Created `TaskDetailScreen.kt` â€” a navigation wrapper composable that:
- Injects `TaskDetailViewModel` via `hiltViewModel()`
- Collects `uiState` and `effect` flows
- Handles effects: `ShowSnackbar`, `ShowError`, `Dismiss`, `TaskDeleted`, `CopyToClipboard`
- Uses Android `ClipboardManager` for clipboard operations
- Delegates rendering to the existing `TaskDetailSheet` composable

**Files Changed**:
- `feature/tasks/detail/TaskDetailScreen.kt` â€” **NEW** (navigation wrapper)
- `navigation/PrioNavHost.kt` â€” Replaced `PlaceholderDetailScreen` with `TaskDetailScreen` on `NavRoutes.TASK_DETAIL` route

### B.2 â€” Overflow Menu in TaskDetail

**Problem**: `TaskDetailSheet`'s `TitleSection` had a non-functional overflow menu button (`onOverflowClick` was a no-op callback).

**Solution**: Implemented a full `DropdownMenu` with four actions:

| Action | Icon | Behavior |
|--------|------|----------|
| Edit | `Icons.Default.Edit` | Toggles `isEditing` state; auto-saves when exiting edit mode |
| Duplicate | `Icons.Default.FileCopy` | Creates copy with "(copy)" suffix via `taskRepository.createTask` |
| Copy Text | `Icons.Default.ContentCopy` | Builds "title\n\nnotes" text, sends `CopyToClipboard` effect |
| Delete | `Icons.Default.Delete` | Existing delete handler |

**Events Added**: `ToggleEditing`, `DuplicateTask`, `CopyToClipboard`

**Files Changed**:
- `feature/tasks/detail/TaskDetailSheet.kt` â€” Rewrote `TitleSection` with `DropdownMenu`, added 3 events
- `feature/tasks/detail/TaskDetailViewModel.kt` â€” Added `toggleEditing()`, `duplicateTask()`, `copyToClipboard()` handlers + `CopyToClipboard` effect

### B.4 â€” Date Picker in Quick Capture

**Problem**: The parsed result preview's date field had a `{ /* TODO: Date picker */ }` click handler â€” users couldn't edit the AI-parsed due date.

**Solution**: Added a Material3 `DatePickerDialog` controlled by `showDatePicker` state:

```
User taps ðŸ“… edit icon
  â†’ ToggleDatePicker event
  â†’ showDatePicker = true
  â†’ DatePickerDialog renders
  â†’ User picks date â†’ OK
  â†’ UpdateParsedDueDate(dateMillis)
  â†’ ViewModel converts millis â†’ Instant â†’ formatted string
  â†’ parsedResult.dueDate + dueDateFormatted updated
```

**State Added**: `showDatePicker: Boolean` in `QuickCaptureUiState`

**Events Added**: `ToggleDatePicker`, `UpdateParsedDueDate(dateMillis: Long?)`

**Files Changed**:
- `feature/capture/QuickCaptureSheet.kt` â€” Added `DatePickerDialog` composable, wired `onDateEditClick` param through `ParsedResultPreview`
- `feature/capture/QuickCaptureViewModel.kt` â€” Added `toggleDatePicker()` and `updateParsedDueDate()` handlers

### B.5 â€” Goal Picker in Quick Capture

**Problem**: The goal field in parsed result preview had `{ /* TODO: Goal picker */ }` â€” users couldn't change the AI-suggested goal or link a task to a different goal.

**Solution**: Created `GoalPickerSheet` â€” a `ModalBottomSheet` composable that:
- Loads active goals from `GoalRepository.getAllActiveGoals()` when opened
- Maps `GoalEntity` to `GoalPickerItem` (id, title, progress, category, emoji)
- Shows "No Goal" option to clear the link
- Shows empty state when no goals exist
- Each goal row shows emoji, title, category, and progress percentage
- Also added a "Link to a goal" button when no goal is currently suggested

**Data Model**: `GoalPickerItem(id, title, progress, category, emoji)`

**State Added**: `showGoalPicker: Boolean`, `availableGoals: List<GoalPickerItem>` in `QuickCaptureUiState`

**Events Added**: `ToggleGoalPicker`, `SelectGoal(goalId: Long?, goalTitle: String?)`

**Files Changed**:
- `feature/capture/QuickCaptureSheet.kt` â€” Added `GoalPickerSheet`, `GoalPickerRow` composables + "Link to a goal" button + `onGoalEditClick` param in `ParsedResultPreview`
- `feature/capture/QuickCaptureViewModel.kt` â€” Added `toggleGoalPicker()` and `selectGoal()` handlers

### B.6 â€” Reminder Indicator on Task Cards

**Problem**: `TaskUiModel` already had `hasReminder: Boolean` but it wasn't surfaced in the UI â€” `TaskCardData` was missing the field, and `MetadataRow` had no reminder display.

**Solution**:
- Added `hasReminder: Boolean = false` to `TaskCardData`
- Updated `MetadataRow` to display a ðŸ”” bell emoji when `hasReminder` is true
- Added separator dot (â€¢) between existing metadata and the bell
- Updated accessibility content description to announce "Reminder set"
- Updated `toCardData()` extension to pass `hasReminder` through

**Files Changed**:
- `core/ui/components/TaskCard.kt` â€” Added `hasReminder` to `TaskCardData`, updated `MetadataRow` with bell indicator, updated accessibility
- `feature/tasks/TaskListScreen.kt` â€” Updated `toCardData()` to map `hasReminder`

---

## Key Decisions

1. **TaskDetailScreen as wrapper, not rewrite**: Rather than embedding ViewModel logic directly into the NavHost, we created a thin wrapper composable that collects effects and delegates to the existing `TaskDetailSheet`. This preserves the sheet's reusability (it can still be shown as a modal from other contexts).

2. **DatePicker over custom date input**: Used Material3's built-in `DatePickerDialog` for consistency with platform conventions. The date picker state is ephemeral (not persisted in ViewModel state) â€” only the selected date millis flows through as an event.

3. **GoalPickerSheet as ModalBottomSheet**: Chose a bottom sheet over a dialog for consistency with the app's navigation patterns. Goals are loaded lazily when the picker opens to avoid unnecessary queries.

4. **Bell emoji over Material Icon**: Used ðŸ”” emoji for the reminder indicator instead of `Icons.Default.Notifications` to keep the metadata row compact and visually consistent with the existing ðŸŽ¯ goal emoji pattern.

5. **Backward-compatible defaults**: All new fields use `= false` / `= emptyList()` defaults, ensuring existing code doesn't break.

---

## Exit Criteria

| Criteria | Status |
|----------|--------|
| All 6 tasks completed | âœ… |
| TaskDetail reachable via navigation | âœ… |
| Overflow menu functional (edit/duplicate/copy/delete) | âœ… |
| Voice input operational | âœ… (B.3 â€” prior session) |
| Date picker in Quick Capture | âœ… |
| Goal picker in Quick Capture | âœ… |
| Reminder indicator visible on cards | âœ… |
| Accessibility descriptions updated | âœ… |
| No breaking changes to existing code | âœ… |
