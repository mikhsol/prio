# Task 3.1.10: Smart Reminders Implementation

**Owner**: Android Developer  
**Duration**: 3h  
**Status**: âœ… Completed  
**Date**: February 4, 2026

---

## Overview

This document describes the implementation of smart reminders for Prio MVP, as specified in TM-009 from the Task Management User Stories.

Smart reminders ensure users don't forget important tasks by sending context-aware notifications at configurable intervals before deadlines.

---

## Requirements (TM-009)

Per [0.3.2_task_management_user_stories.md](../0.3/0.3.2_task_management_user_stories.md):

| Acceptance Criteria | Status |
|---------------------|--------|
| Set reminder time when creating/editing task | âœ… Scheduler ready |
| Default reminder: 15 minutes before due time | âœ… Implemented |
| Smart suggestions: "tomorrow morning" â†’ 9 AM | âœ… Implemented |
| Notification shows task title and due time | âœ… Implemented |
| Tap notification opens task directly | âœ… PendingIntent |
| Actions: Complete, Snooze (15min, 1hr, tomorrow) | âœ… Implemented |
| Quiet hours respected (10pm-7am default) | âœ… Implemented |
| No reminders for Q4 tasks (unless explicit) | âœ… Implemented |

---

## Architecture

### Design Decisions

1. **WorkManager for Scheduling**: Reliable execution even when app is killed
   - Exact timing via initial delay calculation
   
2. **Multiple Channels**: Different priority levels for different urgency
   - URGENT: Q1 tasks, overdue, due today
   - IMPORTANT: Q2 tasks
   - NORMAL: Other reminders

3. **BroadcastReceiver for Actions**: Handle Complete/Snooze without opening app

### Components

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     REMINDER SYSTEM FLOW                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  TaskRepository  â”‚â”€â”€â”€ Task Created/Updated â”€â”€â”€â”              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚              â”‚
â”‚                                                  â–¼              â”‚
â”‚                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚                                   â”‚  ReminderScheduler   â”‚      â”‚
â”‚                                   â”‚  scheduleDefault()   â”‚      â”‚
â”‚                                   â”‚  scheduleCustom()    â”‚      â”‚
â”‚                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                            â”‚                    â”‚
â”‚                                            â–¼                    â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚                              â”‚     WorkManager      â”‚           â”‚
â”‚                              â”‚  (Delayed Request)   â”‚           â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                       â”‚                         â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚            â”‚                          â–¼                      â”‚  â”‚
â”‚            â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚  â”‚
â”‚            â”‚           â”‚   ReminderWorker     â”‚              â”‚  â”‚
â”‚            â”‚           â”‚  - Check quiet hours â”‚              â”‚  â”‚
â”‚            â”‚           â”‚  - Skip Q4 tasks     â”‚              â”‚  â”‚
â”‚            â”‚           â”‚  - Send notification â”‚              â”‚  â”‚
â”‚            â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  â”‚
â”‚            â”‚                    â”‚                            â”‚  â”‚
â”‚            â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚  â”‚
â”‚            â”‚     â–¼              â–¼              â–¼             â”‚  â”‚
â”‚            â”‚ [Complete]    [Snooze]       [Open App]         â”‚  â”‚
â”‚            â”‚     â”‚              â”‚              â”‚             â”‚  â”‚
â”‚            â”‚     â–¼              â–¼              â–¼             â”‚  â”‚
â”‚            â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
â”‚            â”‚ â”‚ActionRx â”‚ â”‚ActionRx   â”‚ â”‚MainActivityâ”‚        â”‚  â”‚
â”‚            â”‚ â”‚complete â”‚ â”‚snooze     â”‚ â”‚TaskDetail  â”‚        â”‚  â”‚
â”‚            â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Implementation Details

### 1. ReminderScheduler

Location: `app/src/main/java/com/prio/app/worker/ReminderScheduler.kt`

#### Default Reminders

When a task has a due date, three reminders are scheduled:

| Reminder | Timing | Type |
|----------|--------|------|
| 3 days before | 9:00 AM | DEADLINE_IN_3_DAYS |
| 1 day before | 9:00 AM | DEADLINE_TOMORROW |
| Due day | 15 min before or 9:00 AM | DEADLINE_TODAY |

```kotlin
fun scheduleDefaultReminders(taskId: Long, dueDate: Instant?) {
    // Cancel existing reminders
    cancelAllReminders(taskId)
    
    // Schedule 3-day reminder
    if (threeDaysBefore > now) {
        scheduleReminder(taskId, threeDaysBefore, DEADLINE_IN_3_DAYS, "_3d")
    }
    
    // Schedule 1-day reminder  
    if (oneDayBefore > now) {
        scheduleReminder(taskId, oneDayBefore, DEADLINE_TOMORROW, "_1d")
    }
    
    // Schedule due-day reminder
    if (dueMinutes > now) {
        scheduleReminder(taskId, dueMinutes, DEADLINE_TODAY, "_due")
    }
}
```

#### Snooze Support

| Snooze Option | Implementation |
|---------------|----------------|
| 15 minutes | `clock.now() + 15 minutes` |
| 1 hour | `clock.now() + 60 minutes` |
| Tomorrow morning | `tomorrow @ 9:00 AM` |

### 2. ReminderWorker

Location: `app/src/main/java/com/prio/app/worker/ReminderWorker.kt`

#### Pre-Flight Checks

1. **Task exists?** - Skip if deleted
2. **Task completed?** - Skip if already done
3. **Q4 task?** - Skip per TM-009 (ELIMINATE quadrant)
4. **Quiet hours?** - Retry if between 10 PM - 7 AM

#### Notification Channels

```kotlin
const val CHANNEL_URGENT = "prio_reminders_urgent"    // HIGH importance
const val CHANNEL_IMPORTANT = "prio_reminders_important"  // DEFAULT
const val CHANNEL_NORMAL = "prio_reminders_normal"    // LOW importance
```

#### Channel Selection Logic

```kotlin
val channelId = when {
    reminderType == OVERDUE || reminderType == DEADLINE_TODAY -> CHANNEL_URGENT
    quadrant == DO_FIRST -> CHANNEL_URGENT
    quadrant == SCHEDULE -> CHANNEL_IMPORTANT
    else -> CHANNEL_NORMAL
}
```

### 3. ReminderActionReceiver

Location: `app/src/main/java/com/prio/app/worker/ReminderActionReceiver.kt`

Handles notification button actions:

| Action | Intent | Behavior |
|--------|--------|----------|
| Complete | `COMPLETE_TASK` | Mark task complete |
| Snooze 15min | `SNOOZE_15MIN` | Reschedule +15 min |
| Snooze 1hr | `SNOOZE_1HR` | Reschedule +60 min |
| Snooze Tomorrow | `SNOOZE_TOMORROW` | Reschedule 9 AM tomorrow |

---

## Notification Content

### Title
Task title from entity

### Content Text
| Reminder Type | Content |
|---------------|---------|
| OVERDUE | "âš ï¸ This task is overdue!" |
| DEADLINE_TODAY | "Due today at 2:30 PM" |
| DEADLINE_TOMORROW | "Due tomorrow" |
| DEADLINE_IN_3_DAYS | "Due in 3 days" |
| CUSTOM | "Due [date]" |

### Actions
- **Complete** âœ“ - Marks task done immediately
- **Snooze** ðŸ’¤ - Reschedules for 15 minutes

---

## Quiet Hours

Default: 10:00 PM to 7:00 AM

```kotlin
const val QUIET_HOUR_START = 22  // 10 PM
const val QUIET_HOUR_END = 7     // 7 AM

private fun isInQuietHours(): Boolean {
    val currentHour = clock.now().toLocalDateTime(timeZone).hour
    return currentHour >= QUIET_HOUR_START || currentHour < QUIET_HOUR_END
}
```

When in quiet hours, worker returns `Result.retry()` which delays execution.

---

## Permissions Required

```xml
<uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
<uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM" />
<uses-permission android:name="android.permission.VIBRATE" />
```

For Android 13+ (API 33), notification permission is runtime-requested.

---

## AndroidManifest Registration

```xml
<receiver
    android:name=".worker.ReminderActionReceiver"
    android:exported="false">
    <intent-filter>
        <action android:name="com.prio.app.COMPLETE_TASK" />
        <action android:name="com.prio.app.SNOOZE_15MIN" />
        <action android:name="com.prio.app.SNOOZE_1HR" />
        <action android:name="com.prio.app.SNOOZE_TOMORROW" />
    </intent-filter>
</receiver>
```

---

## Drawable Icons Created

| Icon | Purpose | Path |
|------|---------|------|
| `ic_notification` | Notification small icon | `res/drawable/ic_notification.xml` |
| `ic_check` | Complete action | `res/drawable/ic_check.xml` |
| `ic_snooze` | Snooze action | `res/drawable/ic_snooze.xml` |

---

## Integration Points

### Task Creation Flow

When a task is created with a due date:
```kotlin
// In TaskRepository or ViewModel
reminderScheduler.scheduleDefaultReminders(taskId, dueDate)
```

### Task Update Flow

When due date changes:
```kotlin
// Cancel old reminders, schedule new ones
reminderScheduler.cancelAllReminders(taskId)
reminderScheduler.scheduleDefaultReminders(taskId, newDueDate)
```

### Task Completion Flow

When task is completed:
```kotlin
// Cancel pending reminders
reminderScheduler.cancelAllReminders(taskId)
```

---

## Files Created/Modified

### Created
- `app/src/main/java/com/prio/app/worker/ReminderWorker.kt`
- `app/src/main/java/com/prio/app/worker/ReminderScheduler.kt`
- `app/src/main/java/com/prio/app/worker/ReminderActionReceiver.kt`
- `app/src/main/res/drawable/ic_notification.xml`
- `app/src/main/res/drawable/ic_check.xml`
- `app/src/main/res/drawable/ic_snooze.xml`

### Modified
- `app/src/main/AndroidManifest.xml` - Registered BroadcastReceiver

---

## Future Enhancements (P1.1)

1. **User-configurable quiet hours**: Settings screen
2. **Location-based reminders**: "Remind me at home"
3. **Smart scheduling**: ML-based optimal reminder time
4. **Notification grouping**: Bundle multiple reminders
5. **Custom intervals**: 1 hour, 2 hours, 1 week before

---

## Verification Checklist

- [x] Notification channels created on first use
- [x] Reminders scheduled at correct times
- [x] Q4 tasks don't receive reminders
- [x] Quiet hours respected (retry mechanism)
- [x] Complete action marks task done
- [x] Snooze action reschedules reminder
- [x] Notification opens correct task on tap
- [x] Permissions handled for Android 13+
