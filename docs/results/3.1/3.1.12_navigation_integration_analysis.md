# 3.1.12 Navigation Integration Analysis

**Date**: February 5, 2026  
**Prepared By**: Principal Android Developer, Product Manager, UX Designer  
**Status**: Gap Identified - Requires New Milestone

---

## Executive Summary

During code review, a critical gap was identified in the ACTION_PLAN.md: **there is no task or milestone to wire the created components together in MainActivity and implement the navigation graph (NavHost)**. 

This is a blocking issue for Phase 3+ development because:
1. Feature plugins (Goals, Calendar, Briefings) cannot be accessed without navigation
2. Bottom navigation bar component exists but isn't integrated
3. Onboarding flow (Milestone 4.1) requires navigation to function
4. End-to-end testing (Milestone 4.3) requires full navigation

---

## Current State Analysis

### What Exists

| Component | Status | Location |
|-----------|--------|----------|
| Navigation Routes (PrioRoute) | ✅ Implemented | [PrioNavigation.kt](../../../android/app/src/main/java/com/prio/app/navigation/PrioNavigation.kt) |
| Bottom Navigation UI | ✅ Implemented | [PrioBottomNavigation.kt](../../../android/core/ui/src/main/java/com/prio/core/ui/components/PrioBottomNavigation.kt) |
| Task List Screen | ✅ Implemented | [TaskListScreen.kt](../../../android/app/src/main/java/com/prio/app/feature/tasks/TaskListScreen.kt) |
| Quick Capture Sheet | ✅ Implemented | [QuickCaptureSheet.kt](../../../android/app/src/main/java/com/prio/app/feature/capture/QuickCaptureSheet.kt) |
| MainActivity | ⚠️ Partial | Shows TaskListScreen only, no bottom nav |

### What's Missing

| Component | Impact | Priority |
|-----------|--------|----------|
| **PrioNavHost.kt** | Cannot navigate between screens | **P0 Blocker** |
| **App Shell (Scaffold + BottomNav)** | No unified app structure | **P0 Blocker** |
| Goals Screens | Milestone 3.2 blocked | P0 |
| Calendar Screens | Milestone 3.3 blocked | P0 |
| Today/Dashboard Screen | Milestone 3.4 blocked | P0 |
| Settings Screens | Milestone 4.1 blocked | P1 |
| Onboarding Flow | Launch blocked | P1 |

### Current MainActivity.kt

```kotlin
// Current implementation - NO NAVIGATION
setContent {
    PrioTheme {
        var showQuickCapture by rememberSaveable { mutableStateOf(false) }
        
        // Shows ONLY TaskListScreen - no bottom nav, no navigation
        TaskListScreen(
            onNavigateToTaskDetail = { /* TODO */ },
            onNavigateToAddTask = { showQuickCapture = true }
        )
        
        // Quick Capture handled as modal
        if (showQuickCapture) { ... }
    }
}
```

---

## Proposed Solution

### New Milestone: 3.1.5 - App Navigation Integration

**Goal**: Wire all components together with Compose Navigation and Bottom Navigation bar  
**Owner**: Android Developer  
**Priority**: P0 - Blocking for Phase 3 continuation  
**Position**: After Milestone 3.1, Before Milestone 3.2  
**Duration**: ~16 hours total

### Architecture Design

```
┌─────────────────────────────────────────────────────────────┐
│                        MainActivity                          │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                     PrioAppShell                       │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │                   Scaffold                       │  │  │
│  │  │  ┌─────────────────────────────────────────┐   │  │  │
│  │  │  │              PrioNavHost                 │   │  │  │
│  │  │  │  ┌─────────────────────────────────┐   │   │  │  │
│  │  │  │  │  composable(Today) { ... }      │   │   │  │  │
│  │  │  │  │  composable(Tasks) { ... }      │   │   │  │  │
│  │  │  │  │  composable(Goals) { ... }      │   │   │  │  │
│  │  │  │  │  composable(Calendar) { ... }   │   │   │  │  │
│  │  │  │  │  composable(Settings) { ... }   │   │   │  │  │
│  │  │  │  │  navigation(onboarding) { ... } │   │   │  │  │
│  │  │  │  └─────────────────────────────────┘   │   │  │  │
│  │  │  └─────────────────────────────────────────┘   │  │  │
│  │  │  ┌─────────────────────────────────────────┐   │  │  │
│  │  │  │          PrioBottomNavigation            │   │  │  │
│  │  │  │  Today │ Tasks │ [FAB] │ Goals │ More   │   │  │  │
│  │  │  └─────────────────────────────────────────┘   │  │  │
│  │  └───────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### Task Breakdown

| ID | Task | Duration | Measurable Outcome |
|----|------|----------|-------------------|
| 3.1.5.1 | Create PrioNavHost with navigation graph | 3h | NavHost with all routes from PrioNavigation.kt |
| 3.1.5.2 | Create PrioAppShell (Scaffold + BottomNav) | 2h | App shell with working bottom navigation |
| 3.1.5.3 | Create placeholder screens (Today, Goals, Calendar, More) | 2h | Basic screens with title, FAB works from any tab |
| 3.1.5.4 | Wire nested navigation (TaskDetail, GoalDetail, etc.) | 2h | Nested destinations with back navigation |
| 3.1.5.5 | Integrate QuickCapture as modal overlay | 1h | FAB shows QuickCapture from any screen |
| 3.1.5.6 | Handle deep links and start destinations | 2h | Onboarding vs main flow routing, notification deep links |
| 3.1.5.7 | Add navigation transitions/animations | 1h | Smooth enter/exit animations per Material 3 |
| 3.1.5.8 | Write navigation tests | 3h | Test all routes, back handling, deep links |

### Files to Create/Modify

**New Files:**
- `android/app/src/main/java/com/prio/app/navigation/PrioNavHost.kt`
- `android/app/src/main/java/com/prio/app/PrioAppShell.kt`
- `android/app/src/main/java/com/prio/app/feature/today/TodayScreen.kt` (placeholder)
- `android/app/src/main/java/com/prio/app/feature/goals/GoalsListScreen.kt` (placeholder)
- `android/app/src/main/java/com/prio/app/feature/calendar/CalendarScreen.kt` (placeholder)
- `android/app/src/main/java/com/prio/app/feature/more/MoreScreen.kt` (placeholder)
- `android/app/src/androidTest/java/com/prio/app/navigation/NavigationTest.kt`

**Modified Files:**
- `android/app/src/main/java/com/prio/app/MainActivity.kt` - Use PrioAppShell instead of direct TaskListScreen

### Dependencies

**Blocking:**
- None - can proceed immediately

**Blocked By This:**
- Milestone 3.2 (Goals Plugin) - needs Goals tab
- Milestone 3.3 (Calendar Plugin) - needs Calendar tab  
- Milestone 3.4 (Daily Briefings) - needs Today tab
- Milestone 4.1 (Onboarding) - needs onboarding navigation graph

### Testing Strategy

| Test Category | Description | Tool |
|---------------|-------------|------|
| Unit Tests | Route creation, navigation state | JUnit 5 + Compose Testing |
| UI Tests | Tab switching, deep links | Compose UI Testing |
| E2E Tests | Full flow from onboarding to task creation | Maestro |

**Acceptance Criteria:**
- [ ] Bottom navigation visible on all main screens
- [ ] FAB triggers QuickCapture from any tab
- [ ] Tab switching preserves state (no re-render)
- [ ] Back button navigates correctly within nested graphs
- [ ] Deep links route to correct screens
- [ ] Onboarding flow can be triggered on first launch
- [ ] Navigation animations smooth (no jank)

---

## E2E Test Plan (Simulator + Real Device)

### Framework Selection

| Framework | Pros | Cons | Recommendation |
|-----------|------|------|----------------|
| **Maestro** | No code changes, YAML flows, cross-platform | External tool | ✅ Primary for E2E |
| **Compose UI Testing** | Native, fast, CI-friendly | Requires instrumented tests | ✅ For unit/integration |
| **Espresso** | Mature, well-documented | Verbose, not Compose-native | ⚪ Fallback only |
| **UI Automator** | Cross-app testing | Limited Compose support | ⚪ For deep links |

### Test Environment Matrix

| Platform | Device | API Level | Purpose |
|----------|--------|-----------|---------|
| Emulator | Pixel 6 | API 34 | CI default, fast |
| Emulator | Pixel 4a | API 29 | Min SDK verification |
| Real Device | Pixel 9a | API 35 | Performance verification |
| Real Device | Samsung S24 | API 34 | OEM compatibility |

### E2E Test Cases

| Test ID | Category | Test Name | Steps | Expected Result | Source |
|---------|----------|-----------|-------|-----------------|--------|
| NAV-E2E-001 | Bottom Nav | Tab switching preserves state | 1. Open Tasks, scroll 2. Tap Goals 3. Tap Tasks | Scroll position preserved | [1.1.12](../1.1/1.1.12_wireframes_spec.md) |
| NAV-E2E-002 | Bottom Nav | All tabs accessible | Tap each tab | Each screen loads correctly | [1.1.12 Nav Map](../1.1/1.1.12_wireframes_spec.md#navigation-map) |
| NAV-E2E-003 | FAB | Quick capture from any tab | On each tab, tap FAB | QuickCapture opens | [TM-001](../0.3/0.3.2_task_management_user_stories.md#tm-001-quick-task-capture) |
| NAV-E2E-004 | Deep Link | Task detail deep link | Open prio://task/{id} | Task detail opens | [TM-006](../0.3/0.3.2_task_management_user_stories.md#tm-006-task-editing) |
| NAV-E2E-005 | Deep Link | Goal detail deep link | Open prio://goal/{id} | Goal detail opens | [GL-002](../0.3/0.3.3_goals_user_stories.md#gl-002-goal-progress-visualization) |
| NAV-E2E-006 | Deep Link | Briefing deep link | Open prio://briefing | Today screen opens | [CB-001](../0.3/0.3.4_calendar_briefings_user_stories.md#cb-001-morning-daily-briefing) |
| NAV-E2E-007 | Back Nav | Nested back navigation | Tasks → Task Detail → Back | Returns to Tasks list | [1.1.2](../1.1/1.1.2_task_detail_sheet_spec.md) |
| NAV-E2E-008 | Back Nav | Settings back navigation | More → Settings → Back | Returns to More | [1.1.9](../1.1/1.1.9_settings_screens_spec.md) |
| NAV-E2E-009 | Onboarding | First launch | Fresh install, launch | Onboarding appears | [1.1.8](../1.1/1.1.8_onboarding_flow_spec.md) |
| NAV-E2E-010 | Onboarding | Skip → Main app | Complete onboarding, relaunch | Main app opens | [1.1.8](../1.1/1.1.8_onboarding_flow_spec.md) |
| NAV-E2E-011 | Animation | Tab transition smoothness | Rapidly tap tabs 10x | 60fps maintained | [1.1.12](../1.1/1.1.12_wireframes_spec.md) |
| NAV-E2E-012 | Edge Case | Rotation during navigation | Open detail, rotate | State preserved | — |

### Maestro Flow Examples

**Tab Switching Test:**
```yaml
# maestro/flows/nav_tab_switching.yaml
appId: com.prio.app
---
- launchApp
- assertVisible: "Today"
- tapOn: "Tasks"
- assertVisible: "TASKS"
- scrollDown
- tapOn: "Goals"
- assertVisible: "Goals"
- tapOn: "Tasks"
- assertVisible: "TASKS"  # Scroll position preserved
```

**FAB from All Tabs Test:**
```yaml
# maestro/flows/nav_quick_capture_all_tabs.yaml
appId: com.prio.app
---
- launchApp
- tapOn:
    id: "fab_add_task"
- assertVisible: "What do you need to do?"
- tapOn: "Cancel"
- tapOn: "Tasks"
- tapOn:
    id: "fab_add_task"
- inputText: "Test task from Tasks"
- tapOn: "Add Task"
- assertVisible: "Test task from Tasks"
```

**Deep Link Test:**
```yaml
# maestro/flows/nav_deep_links.yaml
appId: com.prio.app
---
- launchApp
- tapOn: "Tasks"
- tapOn:
    id: "fab_add_task"
- inputText: "Deep link test"
- tapOn: "Add Task"
- back
- openLink: "prio://task/1"
- assertVisible: "Deep link test"
```

### CI Integration

```yaml
# .github/workflows/e2e-tests.yml
name: E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  e2e-tests:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Install Maestro
        run: curl -Ls "https://get.maestro.mobile.dev" | bash
        
      - name: Run E2E tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          profile: Pixel 6
          script: |
            ./gradlew :app:installDebug
            ~/.maestro/bin/maestro test maestro/flows/ --format junit
            
      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results
          path: maestro/results/
```

---

## Implementation Plan

### Phase 1: Core Navigation (3.1.5.1-3.1.5.3)

```kotlin
// PrioNavHost.kt - Core navigation graph
@Composable
fun PrioNavHost(
    navController: NavHostController,
    modifier: Modifier = Modifier,
    startDestination: PrioRoute = PrioRoute.Today
) {
    NavHost(
        navController = navController,
        startDestination = startDestination,
        modifier = modifier
    ) {
        // Main tabs
        composable<PrioRoute.Today> { TodayScreen(...) }
        composable<PrioRoute.Tasks> { TaskListScreen(...) }
        composable<PrioRoute.Goals> { GoalsListScreen(...) }
        composable<PrioRoute.Calendar> { CalendarScreen(...) }
        composable<PrioRoute.More> { MoreScreen(...) }
        
        // Nested destinations
        composable<PrioRoute.TaskDetail> { backStackEntry ->
            val taskId = backStackEntry.toRoute<PrioRoute.TaskDetail>().taskId
            TaskDetailSheet(...)
        }
        // ... other nested routes
    }
}
```

### Phase 2: App Shell Integration (3.1.5.4-3.1.5.5)

```kotlin
// PrioAppShell.kt - Main app scaffold
@Composable
fun PrioAppShell(
    navController: NavHostController = rememberNavController(),
    onShowQuickCapture: () -> Unit
) {
    val navBackStackEntry by navController.currentBackStackEntryAsState()
    val currentRoute = navBackStackEntry?.destination?.route
    
    val showBottomNav = currentRoute in listOf(
        PrioRoute.Today, PrioRoute.Tasks, PrioRoute.Goals, 
        PrioRoute.Calendar, PrioRoute.More
    ).map { it.route }
    
    Scaffold(
        bottomBar = {
            if (showBottomNav) {
                PrioBottomNavigation(
                    items = defaultNavItems,
                    selectedRoute = currentRoute ?: "today",
                    onItemSelected = { route -> navController.navigate(route) },
                    onFabClick = onShowQuickCapture
                )
            }
        }
    ) { paddingValues ->
        PrioNavHost(
            navController = navController,
            modifier = Modifier.padding(paddingValues)
        )
    }
}
```

### Phase 3: Deep Links & Testing (3.1.5.6-3.1.5.8)

```kotlin
// MainActivity.kt - Updated
override fun onCreate(savedInstanceState: Bundle?) {
    installSplashScreen()
    super.onCreate(savedInstanceState)
    enableEdgeToEdge()
    
    setContent {
        PrioTheme {
            var showQuickCapture by rememberSaveable { mutableStateOf(false) }
            
            PrioAppShell(
                onShowQuickCapture = { showQuickCapture = true }
            )
            
            // Quick Capture overlay
            if (showQuickCapture) {
                QuickCaptureSheet(...)
            }
        }
    }
}
```

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Navigation library version conflicts | Low | Medium | Lock compose-navigation version in libs.versions.toml |
| State loss on configuration change | Medium | Medium | Use rememberSaveable, ViewModel |
| Performance impact from multiple screens | Low | Low | Use Compose navigation lazy loading |
| Deep link handling complexity | Medium | Low | Start with notification deep links only |

---

## Recommendation

**Immediate Action Required:**
1. Add Milestone 3.1.5 to ACTION_PLAN.md immediately after 3.1
2. Mark as **BLOCKING** for Milestones 3.2, 3.3, 3.4, 4.1
3. Prioritize over Goals Plugin (3.2) to unblock parallel development
4. Assign to Android Developer with 2-day sprint allocation

**Impact on Timeline:**
- Adds ~16 hours (2 working days) to Phase 3
- But enables parallel development of 3.2, 3.3, 3.4 once complete
- Net effect: Minimal delay, critical for app usability

---

## References

- [1.1.12 Wireframes Navigation Map](../1.1/1.1.12_wireframes_spec.md#navigation-map)
- [1.2.7 Compose Navigation Setup](../1.2/README.md)
- [PrioNavigation.kt Routes](../../../android/app/src/main/java/com/prio/app/navigation/PrioNavigation.kt)
- [PrioBottomNavigation Component](../../../android/core/ui/src/main/java/com/prio/core/ui/components/PrioBottomNavigation.kt)
- [UX Design System - Navigation Patterns](../../UX_DESIGN_SYSTEM.md#navigation-patterns)
