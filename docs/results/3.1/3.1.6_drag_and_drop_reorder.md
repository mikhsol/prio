# 3.1.6 - Drag-and-Drop Reordering Implementation Report

## Overview

Task 3.1.6 implements drag-and-drop reordering per [1.1.1 Task List Screen Specification](../1.1/1.1.1_task_list_screen_spec.md#drag-and-drop). This allows users to manually reorder tasks within quadrant sections via long-press gesture.

**Status**: âœ… Completed  
**Date**: February 4, 2026  
**Owner**: Android Developer  
**Duration**: 3h

---

## Requirements Implemented

| Requirement | Spec Reference | Status |
|-------------|----------------|--------|
| Long press to reorder (300ms) | 1.1.1 Long Press | âœ… |
| Haptic feedback on drag start | 1.1.1 Long Press | âœ… |
| Visual elevation increase | 1.1.1 Drag and Drop | âœ… |
| Persist order after drop | 1.1.1 Drag and Drop | âœ… |
| Drag handle visibility | 1.1.1 Drag Handle Visibility | âœ… |
| First-time reorder hint | 1.1.1 First-Time Reorder Hint | âœ… |

---

## Implementation Details

### File Location

| File | Purpose |
|------|---------|
| `app/src/main/java/com/prio/app/feature/tasks/reorder/ReorderableList.kt` | Reorderable state, modifiers, UI components |

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ReorderableState<T>                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Properties:                                                     â”‚
â”‚  â”œâ”€ listState: LazyListState                                    â”‚
â”‚  â”œâ”€ draggingItemIndex: Int?                                     â”‚
â”‚  â”œâ”€ draggingItemKey: Any?                                       â”‚
â”‚  â”œâ”€ dragOffset: Float                                           â”‚
â”‚  â””â”€ isDragging: Boolean                                         â”‚
â”‚                                                                  â”‚
â”‚  Functions:                                                      â”‚
â”‚  â”œâ”€ onDragStart(index, key)                                     â”‚
â”‚  â”œâ”€ onDrag(offset)                                              â”‚
â”‚  â””â”€ onDragEnd()                                                 â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Modifier.reorderable()                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Behavior:                                                       â”‚
â”‚  1. detectDragGesturesAfterLongPress                            â”‚
â”‚  2. Haptic feedback on drag start                               â”‚
â”‚  3. Elevation animation (1dp â†’ 8dp)                             â”‚
â”‚  4. Scale animation (1.0 â†’ 1.02)                                â”‚
â”‚  5. Z-index management for dragged item                         â”‚
â”‚  6. Offset translation during drag                              â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Components

#### 1. ReorderableState

Manages the state of drag-and-drop operations:

```kotlin
class ReorderableState<T>(
    val listState: LazyListState,
    private val items: List<T>,
    private val onMove: (fromIndex: Int, toIndex: Int) -> Unit,
    private val onDragEnd: () -> Unit
) {
    var draggingItemIndex by mutableStateOf<Int?>(null)
    var draggingItemKey by mutableStateOf<Any?>(null)
    var dragOffset by mutableFloatStateOf(0f)
    var isDragging by mutableStateOf(false)
    
    fun onDragStart(index: Int, key: Any) { ... }
    fun onDrag(offset: Float) { ... }
    fun onDragEnd() { ... }
}
```

#### 2. Reorderable Modifier

Adds drag-and-drop capability to any composable:

```kotlin
fun <T> Modifier.reorderable(
    state: ReorderableState<T>,
    key: Any,
    index: Int,
    enabled: Boolean = true
): Modifier
```

**Features:**
- Long-press detection (300ms default)
- Haptic feedback (`HapticFeedbackType.LongPress`)
- Animated elevation (1dp â†’ 8dp)
- Scale effect (1.02x during drag)
- Z-index management (dragged item on top)

#### 3. DragHandle Component

Visual indicator for drag capability:

```kotlin
@Composable
fun DragHandle(
    isVisible: Boolean,
    modifier: Modifier = Modifier
)
```

Per spec, appears after long-press to indicate reorder mode.

#### 4. ReorderHint Component

First-time user education:

```kotlin
@Composable
fun ReorderHint(
    isVisible: Boolean,
    onDismiss: () -> Unit,
    modifier: Modifier = Modifier
)
```

Shows: "ğŸ’¡ Long-press and drag to reorder tasks [Got it]"

---

## Usage Example

```kotlin
@Composable
fun TaskListWithReorder(
    tasks: List<TaskUiModel>,
    onReorder: (fromIndex: Int, toIndex: Int) -> Unit,
    onReorderComplete: () -> Unit
) {
    val listState = rememberLazyListState()
    val reorderState = rememberReorderableState(
        items = tasks,
        listState = listState,
        onMove = onReorder,
        onDragEnd = onReorderComplete
    )
    
    LazyColumn(state = listState) {
        items(tasks, key = { it.id }) { task ->
            TaskCard(
                task = task,
                modifier = Modifier.reorderable(
                    state = reorderState,
                    key = task.id,
                    index = tasks.indexOf(task)
                ),
                showDragHandle = reorderState.isDragging
            )
        }
    }
}
```

---

## Visual Behavior

### Normal State
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”´ â”‚ â—‹  Finish Q4 report                      Due: Today  â”‚
â”‚    â”‚    ğŸ¯ Career Goal                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### After Long-Press (Edit Mode)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â‹®â‹® ğŸ”´ â”‚ â—‹  Finish Q4 report                    Due: Today  â”‚
â”‚ â†•     â”‚    ğŸ¯ Career Goal                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 â†‘
 Drag handle appears
```

### During Drag
```
                    â”Œâ”€ Elevated card (8dp shadow)
                    â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ â‹®â‹® ğŸ”´ â”‚ â—‹  Finish Q4 report       Due: Today  â”‚  â† 1.02x scale
              â”‚ â†•     â”‚    ğŸ¯ Career Goal                     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†‘
                    Follows finger position
```

---

## Haptic Feedback

| Action | Feedback Type |
|--------|---------------|
| Drag start | `HapticFeedbackType.LongPress` |
| Item swap | (implicit from movement) |
| Drag end | `HapticFeedbackType.TextHandleMove` |

---

## Accessibility

| Gesture | TalkBack Action |
|---------|-----------------|
| Long-press | Announces "Drag to reorder" |
| Drag handle | Semantic description: "Drag to reorder" |

**Note**: For full accessibility, consider adding Actions API for TalkBack reordering without gestures.

---

## Performance Considerations

1. **Stable Keys**: Using `key = { it.id }` ensures efficient recomposition
2. **Offset Animation**: Uses `Animatable` for smooth 60fps animations
3. **Z-Index Management**: Dragged item renders on top without full recomposition
4. **Immediate Persistence**: Position saved on drop via callback

---

## Integration with ViewModel

```kotlin
// In TaskListViewModel
fun onTaskReorder(fromIndex: Int, toIndex: Int) {
    val currentTasks = _uiState.value.sections[sectionIndex].tasks.toMutableList()
    currentTasks.move(fromIndex, toIndex)
    
    // Update UI immediately
    _uiState.update { ... }
}

fun onReorderComplete() {
    viewModelScope.launch {
        // Persist to database
        taskRepository.updatePositions(reorderedTasks)
    }
}
```

---

## Testing Recommendations

1. **UI Tests**: Long-press detection timing
2. **UI Tests**: Drag gesture recognition
3. **UI Tests**: Drop position accuracy
4. **Unit Tests**: List reordering logic
5. **Accessibility Tests**: TalkBack navigation and actions

---

## Known Limitations

1. **Cross-Quadrant Reorder**: Current implementation reorders within quadrant only. Cross-quadrant drag would change the task's priority (separate feature).

2. **Scroll During Drag**: Auto-scroll when dragging near edges not yet implemented.

3. **Nested Lists**: Not designed for nested LazyColumns.

---

## Future Enhancements

- [ ] Auto-scroll when dragging near list edges
- [ ] Cross-quadrant drag to change priority
- [ ] TalkBack Actions API for accessibility reordering
- [ ] Animation polish (spring physics tuning)

---

*Document Owner: Android Developer*  
*Last Updated: February 4, 2026*
