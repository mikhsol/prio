# 3.1.5 Navigation Integration Implementation Report

**Date**: February 5, 2026  
**Prepared By**: Principal Android Developer  
**Milestone**: 3.1.5 - App Navigation Integration  
**Status**: ğŸŸ¡ IN PROGRESS (Core implementation complete)

---

## Executive Summary

Milestone 3.1.5 Phase 3 implementation is **substantially complete**. The core navigation architecture has been implemented, enabling bottom tab navigation, screen transitions, and the Quick Capture modal. This unblocks development of Milestones 3.2 (Goals Plugin), 3.3 (Calendar Plugin), and 3.4 (Daily Briefings).

---

## Implementation Summary

### Files Created

| File | Purpose | Lines | Status |
|------|---------|-------|--------|
| [PrioNavHost.kt](../../../android/app/src/main/java/com/prio/app/navigation/PrioNavHost.kt) | Navigation graph with all routes | ~320 | âœ… Complete |
| [PrioAppShell.kt](../../../android/app/src/main/java/com/prio/app/PrioAppShell.kt) | Scaffold + BottomNav integration | ~150 | âœ… Complete |
| [PlaceholderDetailScreen.kt](../../../android/app/src/main/java/com/prio/app/navigation/PlaceholderDetailScreen.kt) | Placeholder for detail screens | ~95 | âœ… Complete |
| [TodayScreen.kt](../../../android/app/src/main/java/com/prio/app/feature/today/TodayScreen.kt) | Dashboard placeholder | ~470 | âœ… Complete |
| [GoalsListScreen.kt](../../../android/app/src/main/java/com/prio/app/feature/goals/GoalsListScreen.kt) | Goals list placeholder | ~340 | âœ… Complete |
| [CalendarScreen.kt](../../../android/app/src/main/java/com/prio/app/feature/calendar/CalendarScreen.kt) | Calendar placeholder | ~400 | âœ… Complete |
| [MoreScreen.kt](../../../android/app/src/main/java/com/prio/app/feature/more/MoreScreen.kt) | Settings/More placeholder | ~290 | âœ… Complete |

### Files Modified

| File | Change | Status |
|------|--------|--------|
| [MainActivity.kt](../../../android/app/src/main/java/com/prio/app/MainActivity.kt) | Use PrioAppShell instead of direct TaskListScreen | âœ… Complete |

---

## Architecture Implemented

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        MainActivity                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     PrioAppShell                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚                   Scaffold                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚              PrioNavHost                     â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  composable("today") { TodayScreen }â”‚   â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  composable("tasks") { TaskList }   â”‚   â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  composable("goals") { GoalsList }  â”‚   â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  composable("calendar") { Calendar }â”‚   â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  composable("more") { MoreScreen }  â”‚   â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  composable("task/{id}") { Detail } â”‚   â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  composable("goal/{id}") { Detail } â”‚   â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â”‚  ... (all routes)                   â”‚   â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚          PrioBottomNavigation               â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  Today â”‚ Tasks â”‚ [FAB] â”‚ Goals â”‚ Calendar   â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              QuickCaptureSheet (Modal Overlay)             â”‚  â”‚
â”‚  â”‚              Triggered from FAB on any screen              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Navigation Routes Implemented

### Main Destinations (Bottom Nav)

| Route | Screen | Implementation |
|-------|--------|----------------|
| `today` | TodayScreen | âœ… Placeholder with briefing card, Eisenhower overview, priorities |
| `tasks` | TaskListScreen | âœ… Existing implementation (from 3.1.2) |
| `goals` | GoalsListScreen | âœ… Placeholder with goal cards, progress bars |
| `calendar` | CalendarScreen | âœ… Placeholder with week strip, event timeline |
| `more` | MoreScreen | âœ… Placeholder with settings categories |

### Nested Destinations (Detail Screens)

| Route Pattern | Screen | Implementation |
|---------------|--------|----------------|
| `task/{taskId}` | TaskDetailScreen | ğŸ”² Placeholder (implement in 3.2+) |
| `goal/{goalId}` | GoalDetailScreen | ğŸ”² Placeholder (implement in 3.2) |
| `create_goal` | CreateGoalScreen | ğŸ”² Placeholder (implement in 3.2) |
| `meeting/{meetingId}` | MeetingDetailScreen | ğŸ”² Placeholder (implement in 3.3) |
| `settings` | SettingsScreen | ğŸ”² Placeholder (implement in 4.1) |
| `insights` | InsightsScreen | ğŸ”² Placeholder (post-MVP) |
| `privacy_policy` | PrivacyPolicyScreen | ğŸ”² Placeholder |
| `about` | AboutScreen | ğŸ”² Placeholder |
| `morning_briefing` | MorningBriefingScreen | ğŸ”² Placeholder (implement in 3.4) |
| `evening_summary` | EveningSummaryScreen | ğŸ”² Placeholder (implement in 3.4) |

---

## Task Status Update

### Milestone 3.1.5 Tasks

| ID | Task | Duration | Status | Notes |
|----|------|----------|--------|-------|
| 3.1.5.1 | Create PrioNavHost with navigation graph | 3h | âœ… **Completed** | All routes defined, animations implemented |
| 3.1.5.2 | Create PrioAppShell (Scaffold + BottomNav) | 2h | âœ… **Completed** | Bottom nav visibility, FAB integration |
| 3.1.5.3 | Create placeholder screens | 2h | âœ… **Completed** | Today, Goals, Calendar, More screens |
| 3.1.5.4 | Wire nested navigation | 2h | âœ… **Completed** | TaskDetail, GoalDetail, MeetingDetail routes |
| 3.1.5.5 | Integrate QuickCapture as modal | 1h | âœ… **Completed** | FAB triggers QuickCapture from any screen |
| 3.1.5.6 | Handle deep links and start destinations | 2h | ğŸ”² Not Started | Requires onboarding logic (Milestone 4.1) |
| 3.1.5.7 | Add navigation transitions/animations | 1h | âœ… **Completed** | Fade for tabs, slide for nested |
| 3.1.5.8 | Write navigation E2E tests | 3h | ğŸ”² Not Started | Requires Maestro setup |

**Tasks Completed**: 6/8 (75%)  
**Hours Invested**: ~11h  
**Hours Remaining**: ~5h (deep links + E2E tests)

---

## Technical Decisions

### 1. String-Based Navigation vs Type-Safe Navigation

**Decision**: Use string-based navigation routes.

**Rationale**: 
- Project uses navigation-compose 2.7.7
- Type-safe navigation with `composable<T>` requires 2.8.0+
- Upgrading would require extensive testing and migration
- String-based approach works reliably with current dependencies

**Implementation**:
```kotlin
object NavRoutes {
    const val TODAY = "today"
    const val TASKS = "tasks"
    const val TASK_DETAIL = "task/{taskId}"
    
    fun taskDetail(taskId: Long) = "task/$taskId"
}
```

### 2. Bottom Nav Visibility Logic

**Decision**: Show bottom nav only on main destinations.

**Implementation**:
```kotlin
private fun isMainDestination(route: String?): Boolean {
    val mainRoutes = setOf(
        NavRoutes.TODAY, NavRoutes.TASKS, 
        NavRoutes.GOALS, NavRoutes.CALENDAR, NavRoutes.MORE
    )
    return route in mainRoutes
}
```

### 3. Quick Capture Modal Pattern

**Decision**: QuickCapture as modal overlay in PrioAppShell (not a navigation destination).

**Rationale**:
- Matches TM-001: "FAB visible on all main screens"
- Modal pattern allows capturing from any screen without navigation
- State managed at shell level for consistent access

### 4. Animation Strategy

**Decision**: Simple fade for tabs, slide+fade for nested screens.

**Implementation**:
- Tab switches: 200ms fade
- Nested screens: 300ms slide from right + fade
- Pop (back): 300ms slide to right + fade

---

## Exit Criteria Assessment

| Criterion | Status | Notes |
|-----------|--------|-------|
| Bottom navigation visible on all main screens | âœ… MET | Today, Tasks, Goals, Calendar |
| FAB triggers QuickCapture from any tab | âœ… MET | Modal overlay pattern |
| Tab switching preserves state | âœ… MET | `restoreState = true` in navigation |
| Back button navigates correctly | âœ… MET | `popBackStack()` for nested screens |
| Deep links route to correct screens | ğŸ”² PENDING | Requires Milestone 4.1 work |
| First launch routes to Onboarding | ğŸ”² PENDING | Requires Milestone 4.1 work |
| Navigation animations smooth | âœ… MET | Fade/slide animations implemented |
| 12 E2E tests passing | ğŸ”² PENDING | Requires Maestro setup |

**Exit Criteria Met**: 5/8 (62.5%)  
**Remaining**: Deep links, onboarding routing, E2E tests

---

## Placeholder Screen Features

### TodayScreen (Dashboard)
- Morning Briefing Card
- Eisenhower Quick View (4 quadrant counts)
- Today's Top 3 Priorities
- Goal Progress Row (horizontal scroll)
- Upcoming Events Timeline

### GoalsListScreen
- Summary Card (total goals, avg progress, total tasks)
- Goal Cards with progress bars
- Empty state with CTA
- Links to goal detail

### CalendarScreen
- Week Navigation Bar
- Date Strip (week days)
- Event Cards with time
- Empty day state

### MoreScreen
- Insights Card (prominent)
- Settings Groups (Notifications, Appearance, AI, Calendar, Backup)
- About Section (Privacy, Help, About)

---

## Build Verification

```
BUILD SUCCESSFUL in 43s
120 actionable tasks: 9 executed, 111 up-to-date
```

**Warnings**: 18 (non-blocking, mostly unused parameters in placeholders)  
**Errors**: 0  
**Test Suite**: Not run (E2E tests pending)

---

## Implementation Guide: Deep Links (Task 3.1.5.6)

### Overview

Deep links allow external sources (notifications, widgets, other apps) to navigate directly to specific screens. The navigation infrastructure is readyâ€”this section documents how to integrate deep links.

### Step 1: Add Deep Link Routes to NavRoutes

```kotlin
// In PrioNavHost.kt - NavRoutes object
object NavRoutes {
    // ... existing routes ...
    
    // Deep link URI patterns
    const val DEEP_LINK_HOST = "prio"
    const val DEEP_LINK_SCHEME = "prio"
    
    // Deep link URIs
    fun taskDeepLink(taskId: Long) = "$DEEP_LINK_SCHEME://$DEEP_LINK_HOST/task/$taskId"
    fun goalDeepLink(goalId: Long) = "$DEEP_LINK_SCHEME://$DEEP_LINK_HOST/goal/$goalId"
    fun briefingDeepLink() = "$DEEP_LINK_SCHEME://$DEEP_LINK_HOST/briefing"
}
```

### Step 2: Register Deep Links in NavHost

```kotlin
// In PrioNavHost.kt - add deepLinks parameter to composable()
composable(
    route = NavRoutes.TASK_DETAIL,
    arguments = listOf(navArgument("taskId") { type = NavType.LongType }),
    deepLinks = listOf(
        navDeepLink {
            uriPattern = "prio://prio/task/{taskId}"
        }
    )
) { backStackEntry ->
    val taskId = backStackEntry.arguments?.getLong("taskId") ?: 0L
    // TaskDetailScreen(taskId = taskId, ...)
}

composable(
    route = NavRoutes.GOAL_DETAIL,
    arguments = listOf(navArgument("goalId") { type = NavType.LongType }),
    deepLinks = listOf(
        navDeepLink {
            uriPattern = "prio://prio/goal/{goalId}"
        }
    )
) { backStackEntry ->
    val goalId = backStackEntry.arguments?.getLong("goalId") ?: 0L
    // GoalDetailScreen(goalId = goalId, ...)
}

composable(
    route = NavRoutes.TODAY,
    deepLinks = listOf(
        navDeepLink {
            uriPattern = "prio://prio/briefing"
        }
    )
) {
    TodayScreen(/* show briefing card expanded */)
}
```

### Step 3: Add Intent Filter in AndroidManifest.xml

```xml
<!-- android/app/src/main/AndroidManifest.xml -->
<activity android:name=".MainActivity">
    <!-- Existing intent filter -->
    <intent-filter>
        <action android:name="android.intent.action.MAIN" />
        <category android:name="android.intent.category.LAUNCHER" />
    </intent-filter>
    
    <!-- Deep link intent filter -->
    <intent-filter android:autoVerify="true">
        <action android:name="android.intent.action.VIEW" />
        <category android:name="android.intent.category.DEFAULT" />
        <category android:name="android.intent.category.BROWSABLE" />
        <data 
            android:scheme="prio"
            android:host="prio" />
    </intent-filter>
</activity>
```

### Step 4: Handle Deep Links in MainActivity

```kotlin
// In MainActivity.kt
@AndroidEntryPoint
class MainActivity : ComponentActivity() {
    
    override fun onCreate(savedInstanceState: Bundle?) {
        installSplashScreen()
        super.onCreate(savedInstanceState)
        enableEdgeToEdge()
        
        setContent {
            PrioTheme {
                // Pass initial deep link intent to PrioAppShell
                PrioAppShell(
                    initialDeepLink = intent?.data,
                    onFirstLaunchComplete = { /* save flag */ }
                )
            }
        }
    }
    
    override fun onNewIntent(intent: Intent?) {
        super.onNewIntent(intent)
        // Handle deep link when app is already running
        // NavController will handle via handleDeepLink()
    }
}
```

### Step 5: Process Deep Links in PrioAppShell

```kotlin
// In PrioAppShell.kt
@Composable
fun PrioAppShell(
    modifier: Modifier = Modifier,
    initialDeepLink: Uri? = null,  // NEW parameter
    showOnboarding: Boolean = false,
    onFirstLaunchComplete: () -> Unit = {}
) {
    val navController = rememberNavController()
    
    // Handle initial deep link
    LaunchedEffect(initialDeepLink) {
        initialDeepLink?.let { uri ->
            navController.handleDeepLink(
                Intent().apply { data = uri }
            )
        }
    }
    
    // ... rest of implementation
}
```

### Testing Deep Links

```bash
# Test task deep link
adb shell am start -a android.intent.action.VIEW -d "prio://prio/task/123" com.prio.app

# Test goal deep link  
adb shell am start -a android.intent.action.VIEW -d "prio://prio/goal/456" com.prio.app

# Test briefing deep link
adb shell am start -a android.intent.action.VIEW -d "prio://prio/briefing" com.prio.app
```

---

## Implementation Guide: Onboarding Routing (Task 3.1.5.6)

### Overview

First-time users should see onboarding before the main app. The navigation infrastructure supports conditional start destinations.

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        App Launch                                â”‚
â”‚                            â”‚                                     â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                   â”‚ Check First Run â”‚                           â”‚
â”‚                   â”‚   (DataStore)   â”‚                           â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                            â”‚                                     â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚              â”‚                           â”‚                      â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚      â”‚  First Launch â”‚           â”‚ Returning Userâ”‚              â”‚
â”‚      â”‚   isNew=true  â”‚           â”‚  isNew=false  â”‚              â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚              â”‚                           â”‚                      â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚      â”‚   Onboarding  â”‚           â”‚   Today Tab   â”‚              â”‚
â”‚      â”‚    NavGraph   â”‚           â”‚  (Main App)   â”‚              â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Step 1: Create Onboarding State Repository

```kotlin
// core/data/src/main/java/com/prio/core/data/repository/OnboardingRepository.kt
@Singleton
class OnboardingRepository @Inject constructor(
    private val dataStore: DataStore<Preferences>
) {
    private companion object {
        val ONBOARDING_COMPLETE = booleanPreferencesKey("onboarding_complete")
    }
    
    val isOnboardingComplete: Flow<Boolean> = dataStore.data
        .map { prefs -> prefs[ONBOARDING_COMPLETE] ?: false }
    
    suspend fun setOnboardingComplete() {
        dataStore.edit { prefs ->
            prefs[ONBOARDING_COMPLETE] = true
        }
    }
}
```

### Step 2: Add Onboarding Route

```kotlin
// In PrioNavHost.kt - add onboarding route
object NavRoutes {
    // ... existing routes ...
    const val ONBOARDING = "onboarding"
}

// In NavHost
composable(route = NavRoutes.ONBOARDING) {
    OnboardingScreen(
        onComplete = {
            // Mark complete and navigate to main app
            navController.navigate(NavRoutes.TODAY) {
                popUpTo(NavRoutes.ONBOARDING) { inclusive = true }
            }
        }
    )
}
```

### Step 3: Conditional Start Destination in PrioAppShell

```kotlin
// In PrioAppShell.kt
@Composable
fun PrioAppShell(
    modifier: Modifier = Modifier,
    initialDeepLink: Uri? = null,
    onFirstLaunchComplete: () -> Unit = {}
) {
    // Inject onboarding state
    val onboardingRepository: OnboardingRepository = hiltViewModel<OnboardingViewModel>().repository
    val isOnboardingComplete by onboardingRepository.isOnboardingComplete
        .collectAsStateWithLifecycle(initialValue = null)
    
    // Show loading while checking onboarding state
    if (isOnboardingComplete == null) {
        // Show splash or loading
        Box(Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
            CircularProgressIndicator()
        }
        return
    }
    
    val navController = rememberNavController()
    
    // Determine start destination based on onboarding state
    val startDestination = if (isOnboardingComplete == true) {
        NavRoutes.TODAY
    } else {
        NavRoutes.ONBOARDING
    }
    
    // Bottom nav only visible on main screens (not onboarding)
    val navBackStackEntry by navController.currentBackStackEntryAsState()
    val currentRoute = navBackStackEntry?.destination?.route
    val showBottomNav = isMainDestination(currentRoute) && currentRoute != NavRoutes.ONBOARDING
    
    Scaffold(
        modifier = modifier.fillMaxSize(),
        bottomBar = {
            if (showBottomNav) {
                PrioBottomNavigation(/* ... */)
            }
        }
    ) { contentPadding ->
        PrioNavHost(
            navController = navController,
            contentPadding = contentPadding,
            startDestination = startDestination,  // NEW: pass dynamic start
            onShowQuickCapture = { showQuickCapture = true },
            onOnboardingComplete = {
                onFirstLaunchComplete()
                // This is handled in OnboardingScreen -> navController.navigate()
            }
        )
    }
}
```

### Step 4: Update PrioNavHost for Dynamic Start

```kotlin
// In PrioNavHost.kt
@Composable
fun PrioNavHost(
    navController: NavHostController,
    contentPadding: PaddingValues,
    onShowQuickCapture: () -> Unit,
    startDestination: String = NavRoutes.TODAY,  // NEW parameter
    onOnboardingComplete: () -> Unit = {},       // NEW parameter
    modifier: Modifier = Modifier
) {
    NavHost(
        navController = navController,
        startDestination = startDestination,  // Use dynamic start
        modifier = modifier.padding(contentPadding),
        // ... transitions
    ) {
        // Onboarding destination (hide bottom nav)
        composable(route = NavRoutes.ONBOARDING) {
            OnboardingScreen(
                onComplete = {
                    onOnboardingComplete()
                    navController.navigate(NavRoutes.TODAY) {
                        popUpTo(NavRoutes.ONBOARDING) { inclusive = true }
                    }
                }
            )
        }
        
        // ... rest of destinations
    }
}
```

### Step 5: Create Placeholder OnboardingScreen

```kotlin
// android/app/src/main/java/com/prio/app/feature/onboarding/OnboardingScreen.kt
@Composable
fun OnboardingScreen(
    onComplete: () -> Unit,
    modifier: Modifier = Modifier
) {
    // Placeholder - implement full onboarding in Milestone 4.1
    Column(
        modifier = modifier.fillMaxSize().padding(24.dp),
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center
    ) {
        Text("Welcome to Prio", style = MaterialTheme.typography.headlineLarge)
        Spacer(Modifier.height(16.dp))
        Text("Your Private Productivity AI", style = MaterialTheme.typography.bodyLarge)
        Spacer(Modifier.height(32.dp))
        Button(onClick = onComplete) {
            Text("Get Started")
        }
    }
}
```

### Integration Checklist for Milestone 4.1

- [ ] Create `OnboardingRepository` in `:core:data`
- [ ] Create `OnboardingViewModel` with repository injection
- [ ] Add `ONBOARDING` route to `NavRoutes`
- [ ] Update `PrioNavHost` with `startDestination` parameter
- [ ] Update `PrioAppShell` to check onboarding state
- [ ] Implement full `OnboardingScreen` (3-4 screens per 1.1.8 spec)
- [ ] Add onboarding deep link handling (skip to specific step)
- [ ] Test first launch flow
- [ ] Test returning user flow

---

## Next Steps

### Immediate (to complete 3.1.5)
1. **Task 3.1.5.6**: Deep links and start destinations
   - Implement `prio://task/{id}`, `prio://goal/{id}`, `prio://briefing` deep links
   - Add conditional routing for first launch â†’ Onboarding
   - Coordinate with Milestone 4.1 (Onboarding)

2. **Task 3.1.5.8**: Navigation E2E tests
   - Set up Maestro test infrastructure
   - Implement 12 test cases from test plan
   - Add CI workflow for E2E tests

### Unblocked Work (can proceed in parallel)
- **Milestone 3.2**: Goals Plugin - GoalsListScreen placeholder ready
- **Milestone 3.3**: Calendar Plugin - CalendarScreen placeholder ready
- **Milestone 3.4**: Daily Briefings - TodayScreen placeholder ready
- **Milestone 4.1**: Onboarding - Navigation infrastructure ready

---

## Recommendations

1. **Upgrade navigation-compose to 2.8.x** (post-MVP)
   - Enable type-safe navigation
   - Better compile-time route safety
   - Reduced boilerplate

2. **Consider NavGraph nesting** for feature modules
   - Separate navigation graphs per feature (tasks, goals, calendar)
   - Better code organization as app grows

3. **Add navigation analytics**
   - Track screen views for product insights
   - Measure navigation patterns

---

## References

- [3.1.12 Navigation Integration Analysis](3.1.12_navigation_integration_analysis.md)
- [1.1.12 Wireframes Navigation Map](../1.1/1.1.12_wireframes_spec.md)
- [1.1.13 Component Specifications](../1.1/1.1.13_component_specifications.md)
- [TM-001 Quick Task Capture](../0.3/0.3.2_task_management_user_stories.md#tm-001-quick-task-capture)
- [GL-005 Goals Overview](../0.3/0.3.3_goals_user_stories.md#gl-005-goals-overview-screen)
- [CB-001 Morning Briefing](../0.3/0.3.4_calendar_briefings_user_stories.md#cb-001-morning-daily-briefing)
