# 2.1.9 AnalyticsRepository Implementation

**Task**: Implement AnalyticsRepository  
**Owner**: Android Developer  
**Status**: âœ… Completed  
**Date**: February 4, 2026

---

## Overview

AnalyticsRepository tracks and calculates productivity metrics per the success metrics defined in 0.3.8. It provides completion rate calculation over configurable windows, AI accuracy tracking based on override rates, and event recording for all tracked actions.

---

## Implementation Details

### Location
`core/data/src/main/java/com/prio/core/data/repository/AnalyticsRepository.kt`

### Dependencies
- `DailyAnalyticsDao` - Room DAO for analytics data
- `TaskDao` - For task-based metrics
- `Clock` - Kotlinx-datetime Clock for testability

### Key Features

#### 1. Completion Rate Calculation (0.3.8)
Per success metrics: `(completed/created)` over 7-day window

```kotlin
suspend fun getCompletionRate(
    startDate: LocalDate = getToday().minus(DatePeriod(days = 7)),
    endDate: LocalDate = getToday()
): Float
```

#### 2. AI Accuracy Calculation (0.3.8)
Accuracy = `(total classifications - overrides) / total classifications`

```kotlin
suspend fun getAiAccuracy(...): Float {
    val totalClassifications = dao.getTotalAiClassificationsInRange(...)
    val overrides = dao.getTotalAiOverridesInRange(...)
    
    return if (totalClassifications > 0) {
        (totalClassifications - overrides).toFloat() / totalClassifications
    } else {
        1f // No classifications = no errors
    }
}
```

| Target | Value | Alert Threshold |
|--------|-------|-----------------|
| Launch AI Accuracy | 80% | <70% |
| Month 3 AI Accuracy | 85% | <70% |
| Completion Rate | 60% | <50% |

#### 3. Event Recording
```kotlin
suspend fun recordTaskCreated()
suspend fun recordTaskCompleted(quadrant: EisenhowerQuadrant)
suspend fun recordAiClassification()
suspend fun recordAiOverride()  // TM-010
suspend fun recordGoalProgressed()
suspend fun recordBriefingOpened()  // CB-001
suspend fun recordSummaryOpened()   // CB-003
```

#### 4. Daily Analytics Auto-Creation
```kotlin
suspend fun getOrCreateTodayAnalytics(): DailyAnalyticsEntity {
    val today = getToday()
    val existing = dailyAnalyticsDao.getByDate(today)
    
    return existing ?: run {
        val entity = DailyAnalyticsEntity(date = today)
        val id = dailyAnalyticsDao.insert(entity)
        entity.copy(id = id)
    }
}
```

---

## Test Coverage

### Test File
`core/data/src/test/java/com/prio/core/data/repository/AnalyticsRepositoryTest.kt`

### Test Cases (11 total)

**Completion Rate**
- `getCompletionRate calculates correctly`
- `getCompletionRate returns 0 when no data`

**AI Accuracy**
- `getAiAccuracy calculates correctly`
- `getAiAccuracy returns 1 when no classifications`
- `isAiAccuracyBelowThreshold returns true when below 70%`
- `isAiAccuracyBelowThreshold returns false when at 70%`

**Event Recording**
- `recordTaskCreated increments counter`
- `recordTaskCompleted increments total and quadrant counters`
- `recordAiClassification increments counter`
- `recordAiOverride increments counter`
- `recordBriefingOpened sets flag`
- `getOrCreateTodayAnalytics creates when not exists`

**Summary Statistics**
- `getProductivitySummary returns correct data`
- `getTodayQuadrantBreakdown returns correct data`

---

## Data Models

### ProductivitySummary
```kotlin
data class ProductivitySummary(
    val totalTasksCreated: Int,
    val totalTasksCompleted: Int,
    val completionRate: Float,
    val aiAccuracy: Float,
    val isCompletionRateOnTarget: Boolean,
    val isAiAccuracyOnTarget: Boolean
)
```

### QuadrantBreakdown
```kotlin
data class QuadrantBreakdown(
    val q1Completed: Int,  // DO FIRST
    val q2Completed: Int,  // SCHEDULE
    val q3Completed: Int,  // DELEGATE
    val q4Completed: Int   // ELIMINATE
) {
    val total: Int get() = q1Completed + q2Completed + q3Completed + q4Completed
}
```

---

## Success Metrics Tracked (0.3.8)

| Metric | How Tracked | Repository Method |
|--------|-------------|-------------------|
| DAU | Briefing opened | `recordBriefingOpened()` |
| Task Completion Rate | Created vs Completed | `getCompletionRate()` |
| AI Accuracy | Classifications not overridden | `getAiAccuracy()` |
| Q1 Completion | Urgent+Important completed | `recordTaskCompleted(DO_FIRST)` |

---

*Document Owner: Android Developer*  
*Last Updated: February 4, 2026*
