# 2.1.6 TaskRepository Implementation

**Task**: Implement TaskRepository with Flow  
**Owner**: Android Developer  
**Status**: ✅ Completed  
**Date**: February 4, 2026

---

## Overview

TaskRepository provides a clean interface for all task operations, exposing reactive `Flow` queries and coroutine-based mutations. It implements urgency recalculation per TM-005 and supports all CRUD operations required by TM-001 through TM-010.

---

## Implementation Details

### Location
`core/data/src/main/java/com/prio/core/data/repository/TaskRepository.kt`

### Dependencies
- `TaskDao` - Room DAO for database operations
- `Clock` - Kotlinx-datetime Clock for testability

### Key Features

#### 1. Flow-Based Queries
All read operations return `Flow<List<TaskEntity>>` for reactive UI updates:

```kotlin
fun getAllActiveTasks(): Flow<List<TaskEntity>>
fun getTasksByQuadrant(quadrant: EisenhowerQuadrant): Flow<List<TaskEntity>>
fun getTasksByGoalId(goalId: Long): Flow<List<TaskEntity>>
fun getOverdueTasks(): Flow<List<TaskEntity>>
fun searchTasks(query: String): Flow<List<TaskEntity>>
```

#### 2. Urgency Score Calculation (TM-005)
Automatic urgency calculation based on deadline proximity:

```kotlin
fun calculateUrgencyScore(dueDate: Instant?, now: Instant): Float
```

| Days Until Due | Urgency Score |
|----------------|---------------|
| Overdue | 0.75 - 1.0 (increases with days overdue) |
| Due today | 0.75 |
| Due tomorrow | 0.65 |
| 2-3 days | 0.50 |
| 4-7 days | 0.25 |
| 7+ days | Decreasing from 0.25 |
| No deadline | 0.0 |

#### 3. Task Creation with AI Support (TM-001, TM-003)
```kotlin
suspend fun createTask(
    title: String,
    notes: String? = null,
    dueDate: Instant? = null,
    quadrant: EisenhowerQuadrant = EisenhowerQuadrant.ELIMINATE,
    goalId: Long? = null,
    parentTaskId: Long? = null,
    aiExplanation: String? = null,
    aiConfidence: Float = 0f
): Long
```

#### 4. Quadrant Override (TM-010)
```kotlin
suspend fun updateQuadrant(taskId: Long, quadrant: EisenhowerQuadrant)
```

#### 5. Goal Linking (GL-003)
```kotlin
suspend fun getActiveTasksByGoalId(goalId: Long): List<TaskEntity>
suspend fun getCompletedTasksByGoalId(goalId: Long): List<TaskEntity>
```

---

## Test Coverage

### Test File
`core/data/src/test/java/com/prio/core/data/repository/TaskRepositoryTest.kt`

### Test Cases (17 total)

**Query Operations**
- `getAllActiveTasks returns Flow from DAO`
- `getTasksByQuadrant returns tasks for specific quadrant`
- `getTasksByGoalId returns tasks linked to goal`

**Create Operations**
- `createTask inserts task with calculated urgency`
- `createTask with goal links task correctly`

**Update Operations**
- `completeTask updates completion status`
- `uncompleteTask clears completion status`
- `updateQuadrant changes quadrant`

**Urgency Calculation**
- `calculateUrgencyScore returns 0 for no deadline`
- `calculateUrgencyScore returns high urgency for overdue`
- `calculateUrgencyScore returns high urgency for today`
- `calculateUrgencyScore returns medium urgency for tomorrow`
- `calculateUrgencyScore returns lower urgency for next week`
- `calculateUrgencyScore returns low urgency for far future`

---

## User Stories Implemented

| Story ID | Title | Status |
|----------|-------|--------|
| TM-001 | Quick Task Capture | ✅ `createTask()` |
| TM-003 | AI Eisenhower Classification | ✅ `aiExplanation`, `aiConfidence` fields |
| TM-004 | Task List View | ✅ `getByQuadrant()`, `updatePosition()` |
| TM-005 | Deadline-Based Urgency | ✅ `calculateUrgencyScore()` |
| TM-006 | Complete, Edit, Delete | ✅ Full CRUD operations |
| TM-010 | Override AI Classification | ✅ `updateQuadrant()` |
| GL-003 | Link Tasks to Goals | ✅ `getByGoalId()` support |

---

*Document Owner: Android Developer*  
*Last Updated: February 4, 2026*
