# Task 2.1.11: UserPreferences with DataStore

**Owner**: Android Developer  
**Duration**: 2h  
**Status**: ✅ Completed  
**Date**: February 4, 2026

---

## Overview

This task implements the UserPreferences storage using Android DataStore Preferences. The implementation provides type-safe access to all user settings required for CB-001 (Morning Daily Briefing) and other app-wide preferences.

---

## Requirements (from CB-001)

Per [0.3.4 Calendar & Briefings User Stories](../0.3/0.3.4_calendar_briefings_user_stories.md):

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `morning_briefing_time` | String (HH:mm) | "07:00" | Time for morning briefing notification |
| `evening_summary_time` | String (HH:mm) | "18:00" | Time for evening summary notification |
| `theme` | Enum | SYSTEM | App theme: SYSTEM, LIGHT, DARK |
| `notification_enabled` | Boolean | true | Master notification toggle |

---

## Implementation

### Files Created/Modified

#### New Files

1. **ThemeMode.kt** - Theme mode enum
   ```
   core/common/src/main/java/com/prio/core/common/model/ThemeMode.kt
   ```
   
   Features:
   - `SYSTEM`, `LIGHT`, `DARK` variants
   - `fromString()` parser with case-insensitive matching
   - `toString()` for DataStore serialization

2. **UserPreferences.kt** - Data class for all preferences
   ```
   core/common/src/main/java/com/prio/core/common/model/UserPreferences.kt
   ```
   
   Features:
   - Type-safe data class with all preference fields
   - `LocalTime` for time fields (not string)
   - Helper methods: `parseTime()`, `formatTime()`
   - Computed properties: `isAiLimitReached`, `remainingAiClassifications`
   - `DEFAULT` companion for initial values

3. **UserPreferencesTest.kt** - Unit tests
   ```
   core/data/src/test/java/com/prio/core/data/preferences/UserPreferencesTest.kt
   ```
   
   Coverage:
   - 28 tests across 6 test groups
   - Default values validation
   - Time parsing/formatting
   - AI limit calculations
   - ThemeMode parsing
   - Data class copy behavior

#### Modified Files

1. **UserPreferencesRepository.kt** - Enhanced with combined Flow
   ```
   core/data/src/main/java/com/prio/core/data/preferences/UserPreferencesRepository.kt
   ```
   
   Additions:
   - Import for `ThemeMode`, `UserPreferences`, `LocalTime`
   - `userPreferences: Flow<UserPreferences>` - combined Flow of all prefs
   - `updatePreferences()` - batch update method
   - `clearAll()` - reset all preferences

---

## UserPreferences Data Class

```kotlin
data class UserPreferences(
    // Briefing settings (CB-001)
    val morningBriefingTime: LocalTime = LocalTime(7, 0),
    val eveningSummaryTime: LocalTime = LocalTime(18, 0),
    val briefingEnabled: Boolean = true,
    
    // Theme
    val themeMode: ThemeMode = ThemeMode.SYSTEM,
    
    // Notifications
    val notificationsEnabled: Boolean = true,
    val reminderAdvanceMinutes: Int = 15,
    
    // AI settings
    val aiModelId: String = "phi-3-mini-4k-instruct-q4",
    val aiModelDownloaded: Boolean = false,
    val aiClassificationEnabled: Boolean = true,
    val dailyAiLimit: Int = 5, // Free tier
    val dailyAiUsed: Int = 0,
    
    // Onboarding
    val onboardingCompleted: Boolean = false,
    
    // User profile
    val userName: String? = null,
    
    // Calendar
    val calendarConnected: Boolean = false
)
```

---

## Usage Examples

### Reading Preferences (Reactive)

```kotlin
// Collect individual preference
viewModelScope.launch {
    userPreferencesRepository.themeMode.collect { mode ->
        applyTheme(mode)
    }
}

// Collect all preferences
viewModelScope.launch {
    userPreferencesRepository.userPreferences.collect { prefs ->
        updateUI(prefs)
    }
}
```

### Writing Preferences

```kotlin
// Single preference
viewModelScope.launch {
    userPreferencesRepository.setThemeMode("dark")
}

// Batch update
viewModelScope.launch {
    userPreferencesRepository.updatePreferences { current ->
        current.copy(
            themeMode = ThemeMode.DARK,
            morningBriefingTime = LocalTime(6, 30),
            notificationsEnabled = true
        )
    }
}
```

### AI Usage Tracking

```kotlin
// Check before classification
val prefs = userPreferencesRepository.userPreferences.first()
if (!prefs.isAiLimitReached) {
    performAiClassification()
    userPreferencesRepository.incrementDailyAiUsed()
} else {
    showUpgradePrompt()
}

// Daily reset (call from WorkManager at midnight)
userPreferencesRepository.resetDailyAiUsed()
```

---

## DataStore Keys

All preferences stored in `prio_preferences` DataStore:

| Key | Type | Description |
|-----|------|-------------|
| `morning_briefing_time` | String | Format: "HH:mm" |
| `evening_summary_time` | String | Format: "HH:mm" |
| `briefing_enabled` | Boolean | Enable/disable briefings |
| `theme_mode` | String | "system", "light", "dark" |
| `notifications_enabled` | Boolean | Master notification toggle |
| `reminder_advance_minutes` | Int | Minutes before due time |
| `ai_model_id` | String | Selected AI model ID |
| `ai_model_downloaded` | Boolean | Model download status |
| `ai_classification_enabled` | Boolean | AI feature toggle |
| `daily_ai_limit` | Int | Daily AI usage limit |
| `daily_ai_used` | Int | Today's AI usage count |
| `onboarding_completed` | Boolean | Onboarding flow status |
| `first_launch_date` | String | ISO date of first launch |
| `user_name` | String | User's display name |
| `calendar_connected` | Boolean | Calendar permission granted |
| `selected_calendar_ids` | String | Comma-separated calendar IDs |

---

## Dependency Injection

Provided via Hilt in `PreferencesModule.kt`:

```kotlin
@Module
@InstallIn(SingletonComponent::class)
object PreferencesModule {
    
    @Provides
    @Singleton
    fun provideUserPreferencesRepository(
        @ApplicationContext context: Context
    ): UserPreferencesRepository {
        return UserPreferencesRepository(context)
    }
}
```

---

## Test Coverage

| Test Class | Tests | Status |
|------------|-------|--------|
| UserPreferencesTest | 36 | ✅ All passing |

**Test Categories**:
- Default Values (14 tests)
- Time Parsing (5 tests)
- Time Formatting (3 tests)
- AI Limit Calculations (6 tests)
- ThemeMode (6 tests)
- Data Class Copy (2 tests)

---

## Integration with Other Features

### Morning Briefing (CB-001)
```kotlin
// In BriefingWorker
val prefs = userPreferencesRepository.userPreferences.first()
if (prefs.briefingEnabled) {
    scheduleBriefing(prefs.morningBriefingTime)
}
```

### Theme Application
```kotlin
// In Application.onCreate or MainActivity
userPreferencesRepository.themeMode.collect { mode ->
    when (ThemeMode.fromString(mode)) {
        ThemeMode.DARK -> AppCompatDelegate.setDefaultNightMode(MODE_NIGHT_YES)
        ThemeMode.LIGHT -> AppCompatDelegate.setDefaultNightMode(MODE_NIGHT_NO)
        ThemeMode.SYSTEM -> AppCompatDelegate.setDefaultNightMode(MODE_NIGHT_FOLLOW_SYSTEM)
    }
}
```

### AI Rate Limiting (Pricing Strategy)
```kotlin
// Free tier: 5 AI classifications/day
// Pro tier: Unlimited (set dailyAiLimit = Int.MAX_VALUE)

suspend fun canUseAi(): Boolean {
    val prefs = userPreferencesRepository.userPreferences.first()
    return !prefs.isAiLimitReached
}
```

---

## Future Considerations

1. **Per-Day Briefing Times**: May want different times for weekdays vs weekends
2. **Notification Channels**: Add preference per notification channel
3. **Sync Settings**: Add cloud sync preferences when implemented
4. **Widget Configuration**: Add per-widget preferences
5. **Accessibility**: Add font size, high contrast preferences

---

## Related Documents

- [CB-001 Morning Daily Briefing](../0.3/0.3.4_calendar_briefings_user_stories.md)
- [2.1 Data Layer Overview](README.md)
- [2.1 Migrations Strategy](2.1_migrations_strategy.md)

---

*Document Owner: Android Developer*  
*Last Updated: February 4, 2026*
