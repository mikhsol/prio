# 2.1.7 GoalRepository Implementation

**Task**: Implement GoalRepository with progress calculation  
**Owner**: Android Developer  
**Status**: ✅ Completed  
**Date**: February 4, 2026

---

## Overview

GoalRepository manages goal and milestone operations with automatic progress calculation based on linked task completion. It enforces business rules like maximum active goals (10) and maximum milestones per goal (5).

---

## Implementation Details

### Location
`core/data/src/main/java/com/prio/core/data/repository/GoalRepository.kt`

### Dependencies
- `GoalDao` - Room DAO for goal operations
- `MilestoneDao` - Room DAO for milestone operations
- `TaskDao` - For progress calculation from linked tasks
- `Clock` - Kotlinx-datetime Clock for testability

### Key Features

#### 1. Progress Calculation (GL-002)
Progress is calculated as the percentage of completed linked tasks:

```kotlin
suspend fun recalculateProgress(goalId: Long) {
    val activeTasks = taskDao.getActiveByGoalId(goalId)
    val completedTasks = taskDao.getCompletedByGoalId(goalId)
    
    val totalTasks = activeTasks.size + completedTasks.size
    val progress = if (totalTasks > 0) {
        ((completedTasks.size.toFloat() / totalTasks) * 100).toInt()
    } else {
        0
    }
    
    goalDao.updateProgress(goalId, progress, clock.now())
}
```

#### 2. Goal Status Calculation (GL-002)
Status is determined by comparing actual progress to expected progress:

```kotlin
fun calculateGoalStatus(goal: GoalEntity): GoalStatus {
    // ... calculates expected vs actual progress
    return when {
        difference <= 0 -> GoalStatus.ON_TRACK
        difference <= 15 -> GoalStatus.BEHIND
        else -> GoalStatus.AT_RISK
    }
}
```

| Status | Condition | Color |
|--------|-----------|-------|
| ON_TRACK | Progress >= expected | Green #10B981 |
| BEHIND | Behind by <= 15% | Yellow #F59E0B |
| AT_RISK | Behind by > 15% | Red #EF4444 |
| COMPLETED | Goal finished | Green #10B981 |

#### 3. Maximum Goals Enforcement (GL-001)
```kotlin
companion object {
    const val MAX_ACTIVE_GOALS = 10
}

suspend fun canCreateNewGoal(): Boolean = 
    goalDao.getActiveGoalCount() < MAX_ACTIVE_GOALS

suspend fun createGoal(...): Long? {
    if (!canCreateNewGoal()) return null
    // ... create goal
}
```

#### 4. Milestone Management (GL-004)
```kotlin
companion object {
    const val MAX_MILESTONES_PER_GOAL = 5
}

suspend fun addMilestone(goalId: Long, title: String, targetDate: LocalDate?): Long? {
    val currentCount = milestoneDao.getMilestoneCountForGoal(goalId)
    if (currentCount >= MAX_MILESTONES_PER_GOAL) return null
    // ... add milestone
}
```

---

## Test Coverage

### Test File
`core/data/src/test/java/com/prio/core/data/repository/GoalRepositoryTest.kt`

### Test Cases (13 total)

**Query Operations**
- `getAllActiveGoals returns Flow from DAO`
- `getGoalsByCategory returns goals for specific category`

**Create Operations**
- `createGoal fails when max goals reached`
- `createGoal succeeds when under limit`

**Progress Calculation**
- `recalculateProgress calculates correctly`
- `recalculateProgress handles no tasks`
- `recalculateProgress 100% when all completed`

**Status Calculation**
- `calculateGoalStatus returns COMPLETED for completed goals`
- `calculateGoalStatus returns ON_TRACK when no target date`
- `calculateGoalStatus returns ON_TRACK when ahead`
- `calculateGoalStatus returns AT_RISK when overdue with low progress`

**Milestone Operations**
- `addMilestone fails when max reached`
- `addMilestone succeeds when under limit`
- `getMilestoneProgress returns correct counts`

---

## User Stories Implemented

| Story ID | Title | Status |
|----------|-------|--------|
| GL-001 | Create Goal with AI | ✅ `createGoal()` with max limit |
| GL-002 | Goal Progress Visualization | ✅ `recalculateProgress()`, `calculateGoalStatus()` |
| GL-003 | Link Tasks to Goals | ✅ Progress from linked tasks |
| GL-004 | Goal Milestones | ✅ `addMilestone()`, `completeMilestone()` |
| GL-005 | Goal Dashboard | ✅ `getGoalsNeedingAttention()`, `getDashboardStats()` |

---

## Data Models

### GoalDashboardStats
```kotlin
data class GoalDashboardStats(
    val activeGoals: Int,
    val onTrackCount: Int,
    val atRiskCount: Int,
    val completedThisMonth: Int
)
```

---

*Document Owner: Android Developer*  
*Last Updated: February 4, 2026*
